<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for src/reference.coffee</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../prettify.css" />
    <link rel="stylesheet" href="../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../index.html">all files</a> / <a href="index.html">src/</a> reference.coffee
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">8.2% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>30/366</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">3.17% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>4/126</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">5.41% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>2/37</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">10.98% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>28/255</span>
      </div>
    </div>
  </div>
  <div class='status-line low'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351
352
353
354
355
356
357
358
359
360
361
362
363
364
365
366
367
368
369
370
371
372
373
374
375
376
377
378
379
380
381
382
383
384
385
386
387
388
389
390
391
392
393
394
395
396
397
398
399
400
401
402
403
404
405
406
407
408
409
410
411
412
413
414
415
416
417
418
419
420
421
422
423
424
425
426
427
428</td><td class="line-coverage quiet"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">8×</span>
<span class="cline-any cline-yes">6×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">8×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-yes">8×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js"># IP Address validation
# =================================================
&nbsp;
# The following properties are used:
#
# - spec - reference to the original validation call
#   - name - (string) descriptive name of the data
#   - schema - (object) structure to check
#   - context - (object) additional data structure
#   - dir - set to base directory for file relative file paths
# - path - array containing the current path
# - pos - reference to schema position at this path
# - debug - output of current path for debugging
# - value - value at this path
&nbsp;
# While working on the data the following values will be added:
#
# - data - structure to work on (schema or context)
# - lastType - the type of the last checked reference to ensure security
&nbsp;
&nbsp;
# Node modules
# -------------------------------------------------
debug = require('debug')('validator:reference')
chalk = require 'chalk'
vm = null # load on demand
yaml = null # load on demand
xml2js = null # load on demand
fspath = null # load on demand
request = null # load on demand
exec = null # load on demand
# alinex modules
util = require 'alinex-util'
object = util.object
async = require 'alinex-async'
fs = null # load on demand
# include classes and helper
check = require './check'
&nbsp;
# Configuration
# -------------------------------------------------
# MAXRETRY defines the time to wait till the references should be solved
MAXRETRY = 10000 # waiting for 10 seconds at max
TIMEOUT = 10 # checking every 10ms
&nbsp;
# defines specific type handler for some protocols
protocolMap =
  http: 'web'
  https: 'web'
&nbsp;
# to ensure security a reference can only call references with lower precedence
typePrecedence =
  env: 5
  struct: 4
  context: 3
  file: 2
  cmd: 2
  web: 1
&nbsp;
# Have references
# -------------------------------------------------
# Check if there are references in the object.
exists = exports.exists = (value) -&gt;
  return false unless typeof value is 'string'
  Boolean value.match /&lt;&lt;&lt;[^]*&gt;&gt;&gt;/
&nbsp;
# Replace references
# -------------------------------------------------
# This is called from the check to resolve the references first before running
# the real check. If there are no references it will return immediately.
exports.replace = (value, work={}, cb) -&gt;
  # maybe called without work (mostly for)
  <span class="missing-if-branch" title="if path not taken" >I</span>if typeof work is 'function'
<span class="cstat-no" title="statement not covered" >    cb = work</span>
<span class="cstat-no" title="statement not covered" >    work = {}</span>
  <span class="missing-if-branch" title="else path not taken" >E</span>return cb null, value unless exists value
<span class="cstat-no" title="statement not covered" >  work.data ?= work.spec?.value</span>
<span class="cstat-no" title="statement not covered" >  debug <span class="cstat-no" title="statement not covered" >"replace #{<span class="cstat-no" title="statement not covered" >util.inspect value</span>}..."</span></span>
  # step over parts
<span class="cstat-no" title="statement not covered" >  refs = value.split /(&lt;&lt;&lt;[^]*?&gt;&gt;&gt;)/</span>
<span class="cstat-no" title="statement not covered" ><span class="cstat-no" title="statement not covered" >  refs = [refs[1]]</span> if refs.length is 3 and refs[0] is '' and refs[2] is ''</span>
  # check all references
<span class="cstat-no" title="statement not covered" >  async.map refs, <span class="fstat-no" title="function not covered" >(v, cb) -&gt;</span></span>
<span class="cstat-no" title="statement not covered" >    findAlternative v, work, cb</span>
  , <span class="fstat-no" title="function not covered" >(err, results) -&gt;</span>
<span class="cstat-no" title="statement not covered" ><span class="cstat-no" title="statement not covered" >    return cb()</span> if err</span>
<span class="cstat-no" title="statement not covered" >    if results.length is 1</span>
      # return first result if only one reference used
<span class="cstat-no" title="statement not covered" >      debug "#<span class="cstat-no" title="statement not covered" >{<span class="cstat-no" title="statement not covered" >util.inspect value</span>} is replaced by #{<span class="cstat-no" title="statement not covered" >util.inspect results[0]</span>}</span>"</span>
<span class="cstat-no" title="statement not covered" >      return cb null, results[0]</span>
    # combine reference together
<span class="cstat-no" title="statement not covered" >    result = results.join ''</span>
<span class="cstat-no" title="statement not covered" >    debug "#<span class="cstat-no" title="statement not covered" >{<span class="cstat-no" title="statement not covered" >util.inspect value</span>} is replaced by #{<span class="cstat-no" title="statement not covered" >util.inspect result</span>}</span>"</span>
<span class="cstat-no" title="statement not covered" >    cb null, result</span>
&nbsp;
# Helper methods
# -------------------------------------------------
&nbsp;
# ### search through alternative sources
# Alternative sources are separated by ` | ` and the first possible alternative
# should be used.
<span class="fstat-no" title="function not covered" >findAlternative = (value, work={}, cb) -&gt;</span>
<span class="cstat-no" title="statement not covered" ><span class="cstat-no" title="statement not covered" >  return cb null, value</span> unless ~value.indexOf '&lt;&lt;&lt;'</span>
  # replace &lt;&lt;&lt; and &gt;&gt;&gt; and split into alternatives
<span class="cstat-no" title="statement not covered" >  first = true</span>
<span class="cstat-no" title="statement not covered" >  async.map value[3..-4].split(/\s+\|\s+/), <span class="fstat-no" title="function not covered" >(alt, cb) -&gt;</span></span>
    # automatically set first element to `struct` if no other protocol set
<span class="cstat-no" title="statement not covered" >    if first and not ~alt.indexOf '://'</span>
<span class="cstat-no" title="statement not covered" >      alt = <span class="cstat-no" title="statement not covered" >"struct://#{<span class="cstat-no" title="statement not covered" >alt</span>}</span>"</span>
<span class="cstat-no" title="statement not covered" >    first = false</span>
    # split uri into anchored separated paths
<span class="cstat-no" title="statement not covered" >    alt = alt[0..alt.length-2]</span> <span class="cstat-no" title="statement not covered" >while alt[alt.length-1] is '#'</span>
<span class="cstat-no" title="statement not covered" >    uriPart = alt.split /#/</span>
    # return default value
<span class="cstat-no" title="statement not covered" >    if uriPart.length is 1 and not ~alt.indexOf '://'</span>
<span class="cstat-no" title="statement not covered" >      debug chalk.grey "#<span class="cstat-no" title="statement not covered" >{<span class="cstat-no" title="statement not covered" >util.inspect alt</span>} -&gt; default value: #{<span class="cstat-no" title="statement not covered" >util.inspect alt</span>}</span>"</span>
<span class="cstat-no" title="statement not covered" >      return cb null, alt</span>
    # read value from given uri parts
<span class="cstat-no" title="statement not covered" >    find uriPart, work, <span class="fstat-no" title="function not covered" >(err, result) -&gt;</span></span>
<span class="cstat-no" title="statement not covered" >      if err</span>
<span class="cstat-no" title="statement not covered" >        debug chalk.grey "#<span class="cstat-no" title="statement not covered" >{<span class="cstat-no" title="statement not covered" >util.inspect alt</span>} -&gt; failed: #{<span class="cstat-no" title="statement not covered" >err</span>.message}</span>"</span>
<span class="cstat-no" title="statement not covered" >        return cb err</span>
<span class="cstat-no" title="statement not covered" >      debug chalk.grey "#<span class="cstat-no" title="statement not covered" >{<span class="cstat-no" title="statement not covered" >util.inspect alt</span>} -&gt; result: #{<span class="cstat-no" title="statement not covered" >util.inspect result</span>}</span>"</span>
<span class="cstat-no" title="statement not covered" >      cb null, result</span>
  , <span class="fstat-no" title="function not covered" >(err, results) -&gt;</span>
    # find first alternative
<span class="cstat-no" title="statement not covered" >    for result in results</span>
<span class="cstat-no" title="statement not covered" ><span class="cstat-no" title="statement not covered" >      return cb null, result</span> if result?</span>
<span class="cstat-no" title="statement not covered" >    cb()</span>
&nbsp;
# ### Find reference
# This method is called with all the uri parts as list and will search the
# value of the first uri part, pass it on to the second search as data and so
# on. The result will be from the last uri path.
<span class="fstat-no" title="function not covered" >find = (list, work={}, cb) -&gt;</span>
  # get type of uri part
<span class="cstat-no" title="statement not covered" >  def = list.shift()</span>
<span class="cstat-no" title="statement not covered" ><span class="cstat-no" title="statement not covered" >  return cb null, work.data</span> unless def</span> # empty anchor
  # detect protocol
<span class="cstat-no" title="statement not covered" >  [proto, path] = def.split /:\/\//</span>
<span class="cstat-no" title="statement not covered" >  path ?= proto</span>
<span class="cstat-no" title="statement not covered" >  proto = switch proto[0]</span>
    when '{' then <span class="cstat-no" title="statement not covered" >'check'</span>
    when '%' then <span class="cstat-no" title="statement not covered" >'split'</span>
    when '/' then <span class="cstat-no" title="statement not covered" >'match'</span>
    when '$' then <span class="cstat-no" title="statement not covered" >'parse'</span>
    else
<span class="cstat-no" title="statement not covered" >      if def.match /^\d/ then <span class="cstat-no" title="statement not covered" >'range'</span></span>
      else <span class="cstat-no" title="statement not covered" >unless ~def.indexOf '://'  then <span class="cstat-no" title="statement not covered" >'object'</span></span>
      else <span class="cstat-no" title="statement not covered" >proto</span>
<span class="cstat-no" title="statement not covered" >  if proto is 'parse' and ~path.indexOf '$join'</span>
<span class="cstat-no" title="statement not covered" >    proto = 'join'</span>
  # return if not possible without data (incorrect use)
<span class="cstat-no" title="statement not covered" ><span class="cstat-no" title="statement not covered" >  return cb()</span> if def[0..proto.length-1] isnt proto and not work.data?</span>
  # run automatic conversion of data if needed
<span class="cstat-no" title="statement not covered" >  switch</span>
    when typeof work.data is 'string'
<span class="cstat-no" title="statement not covered" >      switch proto</span>
        when 'range'
<span class="cstat-no" title="statement not covered" >          list.unshift def</span>
<span class="cstat-no" title="statement not covered" >          proto = 'split'</span>
<span class="cstat-no" title="statement not covered" >          path = '%\n'</span>
        when 'object'
<span class="cstat-no" title="statement not covered" >          list.unshift def</span>
<span class="cstat-no" title="statement not covered" >          proto = 'parse'</span>
<span class="cstat-no" title="statement not covered" >          path = '$auto'</span>
    when Array.isArray work.data
<span class="cstat-no" title="statement not covered" >      switch proto</span>
        when 'object', 'split', 'match'
<span class="cstat-no" title="statement not covered" >          list.unshift def</span>
<span class="cstat-no" title="statement not covered" >          proto = 'join'</span>
<span class="cstat-no" title="statement not covered" >          path = '$join'</span>
  # check for impossible result data
<span class="cstat-no" title="statement not covered" >  if (</span>
<span class="cstat-no" title="statement not covered" >    (<span class="cstat-no" title="statement not covered" >not Array.isArray(work.data) and proto in ['range', 'join']</span>) or</span>
    (<span class="cstat-no" title="statement not covered" >typeof work.data isnt 'string' and proto in ['split', 'match', 'parse']</span>) or
    (<span class="cstat-no" title="statement not covered" >typeof work.data isnt 'object' and proto is 'object'</span>)
    )
<span class="cstat-no" title="statement not covered" >      debug chalk.grey <span class="cstat-no" title="statement not covered" >"stop at part #{<span class="cstat-no" title="statement not covered" >proto</span>}://#{<span class="cstat-no" title="statement not covered" >path</span>} because wrong result type"</span></span>
<span class="cstat-no" title="statement not covered" >      return cb()</span>
  # find type handler
<span class="cstat-no" title="statement not covered" >  proto = proto.toLowerCase()</span>
<span class="cstat-no" title="statement not covered" >  type = protocolMap[proto] ? proto</span>
<span class="cstat-no" title="statement not covered" >  debug chalk.grey "check part " + util.inspect "#<span class="cstat-no" title="statement not covered" >{<span class="cstat-no" title="statement not covered" >proto</span>}://#{<span class="cstat-no" title="statement not covered" >path</span>}</span>"</span>
  # check for correct handler
<span class="cstat-no" title="statement not covered" >  unless findType[type]?</span>
<span class="cstat-no" title="statement not covered" >    return cb new Error <span class="cstat-no" title="statement not covered" >"No handler for protocol #{<span class="cstat-no" title="statement not covered" >proto</span>} for references defined"</span></span>
  # check precedence for next uri
<span class="cstat-no" title="statement not covered" >  if work.lastType? and typePrecedence[type] &gt; typePrecedence[work.lastType?]</span>
<span class="cstat-no" title="statement not covered" >    return cb new Error "#<span class="cstat-no" title="statement not covered" >{<span class="cstat-no" title="statement not covered" >type</span>}-reference can not be called from #{<span class="cstat-no" title="statement not covered" >proto</span>}-reference</span></span>
    for security reasons"
  # run type handler and return if nothing found
<span class="cstat-no" title="statement not covered" >  work.lastType = type</span>
<span class="cstat-no" title="statement not covered" >  findType[type] proto, path, work, <span class="fstat-no" title="function not covered" >(err, result) -&gt;</span></span>
<span class="cstat-no" title="statement not covered" ><span class="cstat-no" title="statement not covered" >    return cb err</span> if err</span>
<span class="cstat-no" title="statement not covered" >    unless result # no result so stop this uri</span>
<span class="cstat-no" title="statement not covered" >      if list.length</span>
<span class="cstat-no" title="statement not covered" >        debug chalk.grey util.inspect("#<span class="cstat-no" title="statement not covered" >{<span class="cstat-no" title="statement not covered" >proto</span>}://#{<span class="cstat-no" title="statement not covered" >path</span>}</span>") + " -&gt; result: ---"</span>
<span class="cstat-no" title="statement not covered" >      return cb()</span>
<span class="cstat-no" title="statement not covered" >    if list.length</span>
<span class="cstat-no" title="statement not covered" >      debug chalk.grey util.inspect("#<span class="cstat-no" title="statement not covered" >{<span class="cstat-no" title="statement not covered" >proto</span>}://#{<span class="cstat-no" title="statement not covered" >path</span>}</span>") + <span class="cstat-no" title="statement not covered" >" -&gt; result: #{<span class="cstat-no" title="statement not covered" >util.inspect result</span>}</span>"</span>
    # no reference in result
<span class="cstat-no" title="statement not covered" >    unless exists result</span>
<span class="cstat-no" title="statement not covered" ><span class="cstat-no" title="statement not covered" >      return cb null, result</span> unless list.length</span> # stop if last entry of uri path
<span class="cstat-no" title="statement not covered" >      work = util.clone work</span>
<span class="cstat-no" title="statement not covered" >      work.data = result</span>
<span class="cstat-no" title="statement not covered" >      return find list, work, cb</span>
    # check for retry
<span class="cstat-no" title="statement not covered" >    work.retry ?= 0</span>
<span class="cstat-no" title="statement not covered" >    if work.retry &gt; MAXRETRY/TIMEOUT</span>
<span class="cstat-no" title="statement not covered" >      work.spec.failed = true</span>
<span class="cstat-no" title="statement not covered" >      return throw Error <span class="cstat-no" title="statement not covered" >"Stopped because of circular references at</span></span>
      #{<span class="cstat-no" title="statement not covered" >work</span>.spec.name}/#{<span class="cstat-no" title="statement not covered" >work.path.join '/'</span>}"
    # retry the same call again
<span class="cstat-no" title="statement not covered" >    list.unshift def</span>
<span class="cstat-no" title="statement not covered" >    setTimeout <span class="fstat-no" title="function not covered" >-&gt;</span></span>
<span class="cstat-no" title="statement not covered" ><span class="cstat-no" title="statement not covered" >      return</span> if work.spec.failed</span> # processing already stopped
<span class="cstat-no" title="statement not covered" >      work.retry++</span>
<span class="cstat-no" title="statement not covered" >      find list, work, cb</span>
    , TIMEOUT
&nbsp;
# ### Find value of specific type
# This is a collection of methods for specific protocols.
findType =
  # #### Value checks
<span class="fstat-no" title="function not covered" >  check: (proto, path, work, cb) -&gt;</span>
    # get the check schema reading as js
<span class="cstat-no" title="statement not covered" >    vm ?= require 'vm'</span>
<span class="cstat-no" title="statement not covered" >    schema = vm.runInNewContext <span class="cstat-no" title="statement not covered" >"x=#{<span class="cstat-no" title="statement not covered" >path</span>}</span>"</span>
    # run the subcheck
<span class="cstat-no" title="statement not covered" >    name = work.spec?.name ? 'value'</span>
<span class="cstat-no" title="statement not covered" >    check.run</span>
      name: name + '#ref'
      schema: schema
      value: work.data
    , <span class="fstat-no" title="function not covered" >(err, value) -&gt;</span>
<span class="cstat-no" title="statement not covered" >      if err</span>
<span class="cstat-no" title="statement not covered" >        debug chalk.grey <span class="cstat-no" title="statement not covered" >"'#{<span class="cstat-no" title="statement not covered" >proto</span>}://#{<span class="cstat-no" title="statement not covered" >path</span>}' -&gt; check failed: #{<span class="cstat-no" title="statement not covered" >err</span>.message}</span>"</span>
<span class="cstat-no" title="statement not covered" >        return cb()</span>
<span class="cstat-no" title="statement not covered" >      cb null, value</span>
  # #### Splitting of strings
<span class="fstat-no" title="function not covered" >  split: (proto, path, work, cb) -&gt;</span>
<span class="cstat-no" title="statement not covered" >    path = path[1..]</span>
<span class="cstat-no" title="statement not covered" >    splitter = path.split('//').map <span class="fstat-no" title="function not covered" >(s) -&gt;</span> new <span class="cstat-no" title="statement not covered" >RegExp s</span></span>
<span class="cstat-no" title="statement not covered" ><span class="cstat-no" title="statement not covered" >    splitter.push ''</span> if splitter.length is 1</span>
<span class="cstat-no" title="statement not covered" >    result = work.data.split(splitter[0]).map <span class="fstat-no" title="function not covered" >(t) -&gt;</span></span>
<span class="cstat-no" title="statement not covered" >      col = t.split splitter[1]</span>
<span class="cstat-no" title="statement not covered" >      col.unshift t</span>
<span class="cstat-no" title="statement not covered" >      col</span>
<span class="cstat-no" title="statement not covered" >    result.unshift null</span>
<span class="cstat-no" title="statement not covered" >    cb null, result</span>
  # #### Matching strings
<span class="fstat-no" title="function not covered" >  match: (proto, path, work, cb) -&gt;</span>
<span class="cstat-no" title="statement not covered" >    re = path.match /\/([^]*)\/(i?)/</span>
<span class="cstat-no" title="statement not covered" >    re = new RegExp re[1], "#<span class="cstat-no" title="statement not covered" >{<span class="cstat-no" title="statement not covered" >re</span>[2]}g"</span></span>
<span class="cstat-no" title="statement not covered" >    cb null, work.data.match re</span>
  # #### Special parsing of string
<span class="fstat-no" title="function not covered" >  parse: (proto, path, work, cb) -&gt;</span>
<span class="cstat-no" title="statement not covered" >    switch path</span>
      when '$js'
<span class="cstat-no" title="statement not covered" >        vm ?= require 'vm'</span>
<span class="cstat-no" title="statement not covered" >        cb null, vm.runInNewContext <span class="cstat-no" title="statement not covered" >"x=#{<span class="cstat-no" title="statement not covered" >work</span>.data}</span>"</span>
      when '$json'
<span class="cstat-no" title="statement not covered" >        try</span>
<span class="cstat-no" title="statement not covered" >          result = JSON.parse work.data</span>
        catch error
<span class="cstat-no" title="statement not covered" >          debug chalk.grey <span class="cstat-no" title="statement not covered" >"'#{<span class="cstat-no" title="statement not covered" >proto</span>}://#{<span class="cstat-no" title="statement not covered" >path</span>}' -&gt; check failed: #{<span class="cstat-no" title="statement not covered" >error</span>.message}</span>"</span>
<span class="cstat-no" title="statement not covered" >          return cb()</span>
<span class="cstat-no" title="statement not covered" >        cb null, result</span>
      when '$yaml'
<span class="cstat-no" title="statement not covered" >        yaml ?= require 'js-yaml'</span>
<span class="cstat-no" title="statement not covered" >        try</span>
<span class="cstat-no" title="statement not covered" >          result = yaml.safeLoad work.data</span>
        catch error
<span class="cstat-no" title="statement not covered" >          debug chalk.grey <span class="cstat-no" title="statement not covered" >"'#{<span class="cstat-no" title="statement not covered" >proto</span>}://#{<span class="cstat-no" title="statement not covered" >path</span>}' -&gt; check failed: #{<span class="cstat-no" title="statement not covered" >error</span>.message}</span>"</span>
<span class="cstat-no" title="statement not covered" >          return cb()</span>
<span class="cstat-no" title="statement not covered" >        cb null, result</span>
      when '$xml'
<span class="cstat-no" title="statement not covered" >        xml2js ?= require 'xml2js'</span>
<span class="cstat-no" title="statement not covered" >        xml2js.parseString work.data, <span class="fstat-no" title="function not covered" >(err, result) -&gt;</span></span>
<span class="cstat-no" title="statement not covered" >          if err</span>
<span class="cstat-no" title="statement not covered" >            debug chalk.grey <span class="cstat-no" title="statement not covered" >"'#{<span class="cstat-no" title="statement not covered" >proto</span>}://#{<span class="cstat-no" title="statement not covered" >path</span>}' -&gt; check failed: #{<span class="cstat-no" title="statement not covered" >err</span>.message}</span>"</span>
<span class="cstat-no" title="statement not covered" >            return cb()</span>
<span class="cstat-no" title="statement not covered" >          cb null, result</span>
      when '$auto'
<span class="cstat-no" title="statement not covered" >        result = null</span>
<span class="cstat-no" title="statement not covered" >        async.detectSeries ['$yaml', '$xml', '$json', '$js'], <span class="fstat-no" title="function not covered" >(path, cb) -&gt;</span></span>
<span class="cstat-no" title="statement not covered" >          find [path], work, <span class="fstat-no" title="function not covered" >(err, val) -&gt;</span></span>
<span class="cstat-no" title="statement not covered" >            result = val</span>
<span class="cstat-no" title="statement not covered" >            cb()</span>
        , <span class="fstat-no" title="function not covered" >-&gt;</span>
<span class="cstat-no" title="statement not covered" >          cb null, result</span>
      else
<span class="cstat-no" title="statement not covered" >        cb()</span>
  # #### Range selection in array
<span class="fstat-no" title="function not covered" >  range: (proto, path, work, cb) -&gt;</span>
    # split multiple specifiers
<span class="cstat-no" title="statement not covered" >    rows = path.match ///</span>
      \d+ # first row
      (?:-\d+)? # end of row range
      (?:\[[^\]]+\])? # column specification
      ///g #path.split ','
<span class="cstat-no" title="statement not covered" >    result = []</span>
    # go over rows
<span class="cstat-no" title="statement not covered" >    for row in rows</span>
<span class="cstat-no" title="statement not covered" >      row = row.match ///</span>
        (\d+) # first row
        (?:-(\d+))? # end of row range
        (?:\[([^\]]+)\])? # column specification
        /// #path.split ','
<span class="cstat-no" title="statement not covered" >      row.from = parseInt row[1]</span>
<span class="cstat-no" title="statement not covered" >      row.to = if row[2]? then <span class="cstat-no" title="statement not covered" >parseInt row[2]</span> else <span class="cstat-no" title="statement not covered" >row</span>.from</span>
<span class="cstat-no" title="statement not covered" >      cols = row[3]?.split ','</span>
<span class="cstat-no" title="statement not covered" >      if cols? and Array.isArray work.data[1]</span>
        # get columns
<span class="cstat-no" title="statement not covered" >        for drow in work.data[row.from..row.to]</span>
<span class="cstat-no" title="statement not covered" >          data = []</span>
<span class="cstat-no" title="statement not covered" >          for col in cols</span>
<span class="cstat-no" title="statement not covered" >            col = col.match ///</span>
              (\d+) # first column
              (?:-(\d+))? # end of column range
              /// #path.split ','
<span class="cstat-no" title="statement not covered" >            col.from = parseInt col[1]</span>
<span class="cstat-no" title="statement not covered" >            col.to = if col[2]? then <span class="cstat-no" title="statement not covered" >parseInt col[2]</span> else <span class="cstat-no" title="statement not covered" >col</span>.from</span>
<span class="cstat-no" title="statement not covered" >            data = data.concat drow[col.from..col.to]</span>
<span class="cstat-no" title="statement not covered" >          result.push data</span>
      else
        # get single row
<span class="cstat-no" title="statement not covered" >        for drow in work.data[row.from..row.to]</span>
<span class="cstat-no" title="statement not covered" >          result.push drow[0]</span>
<span class="cstat-no" title="statement not covered" ><span class="cstat-no" title="statement not covered" >    return cb()</span> unless result.length</span>
<span class="cstat-no" title="statement not covered" ><span class="cstat-no" title="statement not covered" >    result = result[0]</span> if result.length is 1</span>
<span class="cstat-no" title="statement not covered" ><span class="cstat-no" title="statement not covered" >    result = result[0]</span> if result.length is 1</span>
<span class="cstat-no" title="statement not covered" >    cb null, result</span>
  # #### Path selection in object
<span class="fstat-no" title="function not covered" >  object: (proto, path, work, cb) -&gt;</span>
<span class="cstat-no" title="statement not covered" >    cb null, object.pathSearch work.data, path</span>
  # #### Join array together
<span class="fstat-no" title="function not covered" >  join: (proto, path, work, cb) -&gt;</span>
<span class="cstat-no" title="statement not covered" >    path = path[6..]</span>
<span class="cstat-no" title="statement not covered" >    splitter = if path then <span class="cstat-no" title="statement not covered" >path.split '//'</span> else <span class="cstat-no" title="statement not covered" >[', ']</span></span>
<span class="cstat-no" title="statement not covered" >    cb null, arrayJoin work.data, splitter</span>
  # #### Accessing environment variable
<span class="fstat-no" title="function not covered" >  env: (proto, path, work, cb) -&gt;</span>
<span class="cstat-no" title="statement not covered" >    cb null, process.env[path]</span>
  # #### Read from value structure
<span class="fstat-no" title="function not covered" >  struct: (proto, path, work, cb) -&gt;</span>
<span class="cstat-no" title="statement not covered" >    findData path, work, cb</span>
  # #### Read from additional context
<span class="fstat-no" title="function not covered" >  context: (proto, path, work, cb) -&gt;</span>
<span class="cstat-no" title="statement not covered" >    cb null, object.pathSearch work.spec?.context, path</span>
  # #### Read from file
<span class="fstat-no" title="function not covered" >  file: (proto, path, work, cb) -&gt;</span>
<span class="cstat-no" title="statement not covered" >    fs ?= require 'alinex-fs'</span>
<span class="cstat-no" title="statement not covered" >    fspath ?= require 'path'</span>
<span class="cstat-no" title="statement not covered" ><span class="cstat-no" title="statement not covered" >    path = fspath.resolve work.spec.dir, path</span> if work.spec?.dir?</span>
<span class="cstat-no" title="statement not covered" >    fs.realpath path, <span class="fstat-no" title="function not covered" >(err, path) -&gt;</span></span>
<span class="cstat-no" title="statement not covered" ><span class="cstat-no" title="statement not covered" >      return cb err</span> if err</span>
<span class="cstat-no" title="statement not covered" >      fs.readFile path, 'utf-8', cb</span>
  # #### Read from web resource
<span class="fstat-no" title="function not covered" >  web: (proto, path, work, cb) -&gt;</span>
<span class="cstat-no" title="statement not covered" >    request ?= require 'request'</span>
<span class="cstat-no" title="statement not covered" >    request</span>
      uri: "#<span class="cstat-no" title="statement not covered" >{<span class="cstat-no" title="statement not covered" >proto</span>}://#{<span class="cstat-no" title="statement not covered" >path</span>}</span>"
      followAllRedirects: true
    , <span class="fstat-no" title="function not covered" >(err, response, body) -&gt;</span>
      # error checking
<span class="cstat-no" title="statement not covered" ><span class="cstat-no" title="statement not covered" >      return cb err</span> if err</span>
<span class="cstat-no" title="statement not covered" >      if response.statusCode isnt 200</span>
<span class="cstat-no" title="statement not covered" >        return cb new Error <span class="cstat-no" title="statement not covered" >"Server send wrong return code: #{<span class="cstat-no" title="statement not covered" >response</span>.statusCode}</span>"</span>
<span class="cstat-no" title="statement not covered" ><span class="cstat-no" title="statement not covered" >      return cb()</span> unless body?</span>
<span class="cstat-no" title="statement not covered" >      cb null, body</span>
  # #### Read from command output
<span class="fstat-no" title="function not covered" >  cmd: (proto, path, work, cb) -&gt;</span>
<span class="cstat-no" title="statement not covered" >    exec ?= require('child_process').exec</span>
<span class="cstat-no" title="statement not covered" >    opt = {}</span>
<span class="cstat-no" title="statement not covered" ><span class="cstat-no" title="statement not covered" >    opt.cwd = work.spec.dir</span> if work.spec?.dir?</span>
<span class="cstat-no" title="statement not covered" >    exec path, opt, <span class="fstat-no" title="function not covered" >(err, result) -&gt;</span></span>
<span class="cstat-no" title="statement not covered" ><span class="cstat-no" title="statement not covered" >      return cb err</span> if err</span>
<span class="cstat-no" title="statement not covered" >      cb null, result.trim()</span>
&nbsp;
# ### Read from value structure
<span class="fstat-no" title="function not covered" >findData = (path, work, cb) -&gt;</span>
  # split path
<span class="cstat-no" title="statement not covered" ><span class="cstat-no" title="statement not covered" >  path = path.replace('/\/+$/', '').split /\/+/</span> if typeof path is 'string'</span>
<span class="cstat-no" title="statement not covered" >  work.path ?= []</span>
  # find first level
<span class="cstat-no" title="statement not covered" >  first = path[0]</span>
  # absolute path, go on
<span class="cstat-no" title="statement not covered" ><span class="cstat-no" title="statement not covered" >  return cb null, object.pathSearch work.data, path[1..]</span> if first is ''</span>
  # search at current position
<span class="cstat-no" title="statement not covered" >  skip = 0</span>
<span class="cstat-no" title="statement not covered" >  skip++</span> <span class="cstat-no" title="statement not covered" >while path[skip] is '..'</span>
<span class="cstat-no" title="statement not covered" >  result = object.pathSearch work.data, work.path[0..work.path.length-skip-1].concat path[skip..]</span>
<span class="cstat-no" title="statement not covered" >  if result and work.spec?.done?</span>
<span class="cstat-no" title="statement not covered" >    checkpath = work.path[0..work.path.length-skip-1].concat(path[skip..]).join '/'</span>
<span class="cstat-no" title="statement not covered" >    unless checkpath in work.spec.done</span>
      # check for retry
<span class="cstat-no" title="statement not covered" >      work.retry ?= 0</span>
<span class="cstat-no" title="statement not covered" >      if work.retry &gt; MAXRETRY/TIMEOUT</span>
<span class="cstat-no" title="statement not covered" >        work.spec.failed = true</span>
<span class="cstat-no" title="statement not covered" >        return throw Error <span class="cstat-no" title="statement not covered" >"Stopped because of uncheckable #{<span class="cstat-no" title="statement not covered" >work</span>.spec.name}/#{<span class="cstat-no" title="statement not covered" >checkpath</span>}</span>"</span>
<span class="cstat-no" title="statement not covered" >      return setTimeout <span class="fstat-no" title="function not covered" >-&gt;</span></span>
<span class="cstat-no" title="statement not covered" ><span class="cstat-no" title="statement not covered" >        return</span> if work.spec.failed</span> # processing already stopped
<span class="cstat-no" title="statement not covered" >        work.retry++</span>
        # reread value from spec
<span class="cstat-no" title="statement not covered" >        work.data = work.spec.value</span>
<span class="cstat-no" title="statement not covered" >        findData path, work, cb</span>
      , TIMEOUT
<span class="cstat-no" title="statement not covered" ><span class="cstat-no" title="statement not covered" >  return cb null, result</span> if result</span>
  # check if not at the end
<span class="cstat-no" title="statement not covered" ><span class="cstat-no" title="statement not covered" >  return cb()</span> unless work.path.length</span>
  # search neighbors by sub call on parent
<span class="cstat-no" title="statement not covered" >  sub = util.clone work</span>
<span class="cstat-no" title="statement not covered" >  sub.spec = work.spec</span>
<span class="cstat-no" title="statement not covered" >  sub.path.pop()</span>
<span class="cstat-no" title="statement not covered" >  findData path, sub, cb</span>
&nbsp;
# ### Recursively join array of arrays together
<span class="fstat-no" title="function not covered" >arrayJoin = (data, splitter) -&gt;</span>
<span class="cstat-no" title="statement not covered" >  glue = if splitter.length is 1 then <span class="cstat-no" title="statement not covered" >splitter</span>[0] else <span class="cstat-no" title="statement not covered" >splitter.shift()</span></span>
<span class="cstat-no" title="statement not covered" >  result = ''</span>
<span class="cstat-no" title="statement not covered" >  for v in data</span>
<span class="cstat-no" title="statement not covered" ><span class="cstat-no" title="statement not covered" >    v = arrayJoin v, splitter</span> if Array.isArray v</span>
<span class="cstat-no" title="statement not covered" ><span class="cstat-no" title="statement not covered" >    result += glue</span> if result</span>
<span class="cstat-no" title="statement not covered" >    result += v</span>
<span class="cstat-no" title="statement not covered" >  result</span>
&nbsp;</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Wed Apr 20 2016 22:00:03 GMT+0200 (CEST)
</div>
</div>
<script src="../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../sorter.js"></script>
</body>
</html>
