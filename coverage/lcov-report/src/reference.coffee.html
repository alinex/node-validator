<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for src/reference.coffee</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../prettify.css" />
    <link rel="stylesheet" href="../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../index.html">all files</a> / <a href="index.html">src/</a> reference.coffee
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">87.47% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>314/359</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">85.71% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>108/126</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">97.3% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>36/37</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">92.74% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>230/248</span>
      </div>
    </div>
  </div>
  <div class='status-line high'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351
352
353
354
355
356
357
358
359
360
361
362
363
364
365
366
367
368
369
370
371
372
373
374
375
376
377
378
379
380
381
382
383
384
385
386
387
388
389
390
391
392
393
394
395
396
397
398
399
400
401
402
403
404
405
406
407
408
409
410
411
412
413
414
415
416
417
418
419
420
421</td><td class="line-coverage quiet"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">7274×</span>
<span class="cline-any cline-yes">3518×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">7144×</span>
<span class="cline-any cline-yes">27×</span>
<span class="cline-any cline-yes">27×</span>
<span class="cline-any cline-yes">7144×</span>
<span class="cline-any cline-yes">112×</span>
<span class="cline-any cline-yes">112×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">112×</span>
<span class="cline-any cline-yes">112×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">112×</span>
<span class="cline-any cline-yes">118×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">109×</span>
<span class="cline-any cline-yes">109×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">107×</span>
<span class="cline-any cline-yes">107×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">118×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">113×</span>
<span class="cline-any cline-yes">113×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">125×</span>
<span class="cline-any cline-yes">42×</span>
<span class="cline-any cline-yes">125×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">125×</span>
<span class="cline-any cline-yes">125×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">125×</span>
<span class="cline-any cline-yes">10×</span>
<span class="cline-any cline-yes">10×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">115×</span>
<span class="cline-any cline-yes">112×</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-yes">108×</span>
<span class="cline-any cline-yes">108×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">110×</span>
<span class="cline-any cline-yes">118×</span>
<span class="cline-any cline-yes">29×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">163×</span>
<span class="cline-any cline-yes">163×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">163×</span>
<span class="cline-any cline-yes">163×</span>
<span class="cline-any cline-yes">163×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">5×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">11×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">145×</span>
<span class="cline-any cline-yes">128×</span>
<span class="cline-any cline-yes">115×</span>
<span class="cline-any cline-yes">163×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">163×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">163×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">23×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">8×</span>
<span class="cline-any cline-yes">8×</span>
<span class="cline-any cline-yes">8×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">12×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">163×</span>
<span class="cline-any cline-yes">163×</span>
<span class="cline-any cline-yes">162×</span>
<span class="cline-any cline-yes">162×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">162×</span>
<span class="cline-any cline-yes">162×</span>
<span class="cline-any cline-yes">162×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">162×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">162×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">162×</span>
<span class="cline-any cline-yes">162×</span>
<span class="cline-any cline-yes">159×</span>
<span class="cline-any cline-yes">155×</span>
<span class="cline-any cline-yes">35×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-yes">35×</span>
<span class="cline-any cline-yes">120×</span>
<span class="cline-any cline-yes">44×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">120×</span>
<span class="cline-any cline-yes">120×</span>
<span class="cline-any cline-yes">44×</span>
<span class="cline-any cline-yes">44×</span>
<span class="cline-any cline-yes">44×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">12×</span>
<span class="cline-any cline-yes">14×</span>
<span class="cline-any cline-yes">12×</span>
<span class="cline-any cline-yes">12×</span>
<span class="cline-any cline-yes">114×</span>
<span class="cline-any cline-yes">114×</span>
<span class="cline-any cline-yes">114×</span>
<span class="cline-any cline-yes">12×</span>
<span class="cline-any cline-yes">12×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">9×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">8×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">8×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">8×</span>
<span class="cline-any cline-yes">11×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">11×</span>
<span class="cline-any cline-yes">11×</span>
<span class="cline-any cline-yes">11×</span>
<span class="cline-any cline-yes">11×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">5×</span>
<span class="cline-any cline-yes">7×</span>
<span class="cline-any cline-yes">7×</span>
<span class="cline-any cline-yes">9×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">9×</span>
<span class="cline-any cline-yes">9×</span>
<span class="cline-any cline-yes">9×</span>
<span class="cline-any cline-yes">7×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">6×</span>
<span class="cline-any cline-yes">10×</span>
<span class="cline-any cline-yes">8×</span>
<span class="cline-any cline-yes">8×</span>
<span class="cline-any cline-yes">8×</span>
<span class="cline-any cline-yes">8×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">12×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">10×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">93×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3173×</span>
<span class="cline-any cline-yes">3173×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3173×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3173×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3142×</span>
<span class="cline-any cline-yes">3142×</span>
<span class="cline-any cline-yes">3142×</span>
<span class="cline-any cline-yes">3142×</span>
<span class="cline-any cline-yes">3033×</span>
<span class="cline-any cline-yes">3033×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3010×</span>
<span class="cline-any cline-yes">3010×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">3009×</span>
<span class="cline-any cline-yes">3009×</span>
<span class="cline-any cline-yes">3007×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3007×</span>
<span class="cline-any cline-yes">3007×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">132×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">92×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">73×</span>
<span class="cline-any cline-yes">73×</span>
<span class="cline-any cline-yes">73×</span>
<span class="cline-any cline-yes">73×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">8×</span>
<span class="cline-any cline-yes">8×</span>
<span class="cline-any cline-yes">8×</span>
<span class="cline-any cline-yes">24×</span>
<span class="cline-any cline-yes">24×</span>
<span class="cline-any cline-yes">24×</span>
<span class="cline-any cline-yes">8×</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js"># IP Address validation
# =================================================
&nbsp;
# The following properties are used:
#
# - spec - reference to the original validation call
#   - name - (string) descriptive name of the data
#   - schema - (object) structure to check
#   - context - (object) additional data structure
#   - dir - set to base directory for file relative file paths
# - path - array containing the current path
# - pos - reference to schema position at this path
# - debug - output of current path for debugging
# - value - value at this path
&nbsp;
# While working on the data the following values will be added:
#
# - data - structure to work on (schema or context)
# - lastType - the type of the last checked reference to ensure security
&nbsp;
&nbsp;
# Node modules
# -------------------------------------------------
debug = require('debug')('validator:reference')
util = require 'util'
chalk = require 'chalk'
# alinex modules
async = require 'alinex-async'
{object} = require 'alinex-util'
# include classes and helper
check = require './check'
&nbsp;
# Configuration
# -------------------------------------------------
# MAXRETRY defines the time to wait till the references should be solved
MAXRETRY = 10000 # waiting for 10 seconds at max
TIMEOUT = 10 # checking every 10ms
&nbsp;
# defines specific type handler for some protocols
protocolMap =
  http: 'web'
  https: 'web'
&nbsp;
# to ensure security a reference can only call references with lower precedence
typePrecedence =
  env: 5
  struct: 4
  context: 3
  file: 2
  cmd: 2
  web: 1
&nbsp;
# Have references
# -------------------------------------------------
# Check if there are references in the object.
exists = exports.exists = (value) -&gt;
  return false unless typeof value is 'string'
  Boolean value.match /&lt;&lt;&lt;[^]*&gt;&gt;&gt;/
&nbsp;
# Replace references
# -------------------------------------------------
# This is called from the check to resolve the references first before running
# the real check. If there are no references it will return immediately.
exports.replace = (value, work={}, cb) -&gt;
  # maybe called without work (mostly for)
  if typeof work is 'function'
    cb = work
    work = {}
  return cb null, value unless exists value
  work.data ?= work.spec?.value
  debug "replace #{util.inspect value}..."
  # step over parts
  refs = value.split /(&lt;&lt;&lt;[^]*?&gt;&gt;&gt;)/
  refs = [refs[1]] if refs.length is 3 and refs[0] is '' and refs[2] is ''
  # check all references
  async.map refs, (v, cb) -&gt;
    findAlternative v, work, cb
  , (err, results) -&gt;
<span class="cstat-no" title="statement not covered" >    <span class="missing-if-branch" title="if path not taken" >I</span>return cb()</span> if err
    if results.length is 1
      # return first result if only one reference used
      debug "#{util.inspect value} is replaced by #{util.inspect results[0]}"
      return cb null, results[0]
    # combine reference together
    result = results.join ''
    debug "#{util.inspect value} is replaced by #{util.inspect result}"
    cb null, result
&nbsp;
# Helper methods
# -------------------------------------------------
&nbsp;
# ### search through alternative sources
# Alternative sources are separated by ` | ` and the first possible alternative
# should be used.
findAlternative = (value, work={}, cb) -&gt;
  return cb null, value unless ~value.indexOf '&lt;&lt;&lt;'
  # replace &lt;&lt;&lt; and &gt;&gt;&gt; and split into alternatives
  first = true
  async.map value[3..-4].split(/\s+\|\s+/), (alt, cb) -&gt;
    # automatically set first element to `struct` if no other protocol set
    if first and not ~alt.indexOf '://'
      alt = "struct://#{alt}"
    first = false
    # split uri into anchored separated paths
    alt = alt[0..alt.length-2] while alt[alt.length-1] is '#'
    uriPart = alt.split /#/
    # return default value
    if uriPart.length is 1 and not ~alt.indexOf '://'
      debug chalk.grey "#{util.inspect alt} -&gt; default value: #{util.inspect alt}"
      return cb null, alt
    # read value from given uri parts
    find uriPart, work, (err, result) -&gt;
      if err
        debug chalk.grey "#{util.inspect alt} -&gt; failed: #{err.message}"
        return cb err
      debug chalk.grey "#{util.inspect alt} -&gt; result: #{util.inspect result}"
      cb null, result
  , (err, results) -&gt;
    # find first alternative
    for result in results
      return cb null, result if result?
    cb()
&nbsp;
# ### Find reference
# This method is called with all the uri parts as list and will search the
# value of the first uri part, pass it on to the second search as data and so
# on. The result will be from the last uri path.
find = (list, work={}, cb) -&gt;
  # get type of uri part
  def = list.shift()
<span class="cstat-no" title="statement not covered" >  <span class="missing-if-branch" title="if path not taken" >I</span>return cb null, work.data</span> unless def # empty anchor
  # detect protocol
  [proto, path] = def.split /:\/\//
  path ?= proto
  proto = switch proto[0]
    when '{' then 'check'
    when '%' then 'split'
    when '/' then 'match'
    when '$' then 'parse'
    else
      if def.match /^\d/ then 'range'
      else unless ~def.indexOf '://'  then 'object'
      else proto
  if proto is 'parse' and ~path.indexOf '$join'
    proto = 'join'
  # return if not possible without data (incorrect use)
<span class="cstat-no" title="statement not covered" >  <span class="missing-if-branch" title="if path not taken" >I</span>return cb()</span> if def[0..proto.length-1] isnt proto and not work.data?
  # run automatic conversion of data if needed
  switch
    when typeof work.data is 'string'
      switch proto
        when 'range'
          list.unshift def
          proto = 'split'
          path = '%\n'
        when 'object'
          list.unshift def
          proto = 'parse'
          path = '$auto'
    when Array.isArray work.data
      switch proto
        when 'object', 'split', 'match'
          list.unshift def
          proto = 'join'
          path = '$join'
  # check for impossible result data
  if (
    (not Array.isArray(work.data) and proto in ['range', 'join']) or
    (typeof work.data isnt 'string' and proto in ['split', 'match', 'parse']) or
    (typeof work.data isnt 'object' and proto is 'object')
    )
      debug chalk.grey "stop at part #{proto}://#{path} because wrong result type"
      return cb()
  # find type handler
  proto = proto.toLowerCase()
  type = protocolMap[proto] ? proto
  debug chalk.grey "check part " + util.inspect "#{proto}://#{path}"
  # check for correct handler
  <span class="missing-if-branch" title="if path not taken" >I</span>unless findType[type]?
<span class="cstat-no" title="statement not covered" >    return cb new Error <span class="cstat-no" title="statement not covered" >"No handler for protocol #{<span class="cstat-no" title="statement not covered" >proto</span>} for references defined"</span></span>
  # check precedence for next uri
  <span class="missing-if-branch" title="if path not taken" >I</span>if work.lastType? and typePrecedence[type] &gt; typePrecedence[work.lastType?]
<span class="cstat-no" title="statement not covered" >    return cb new Error "#<span class="cstat-no" title="statement not covered" >{<span class="cstat-no" title="statement not covered" >type</span>}-reference can not be called from #{<span class="cstat-no" title="statement not covered" >proto</span>}-reference</span></span>
    for security reasons"
  # run type handler and return if nothing found
  work.lastType = type
  findType[type] proto, path, work, (err, result) -&gt;
    return cb err if err
    unless result # no result so stop this uri
      <span class="missing-if-branch" title="if path not taken" >I</span>if list.length
<span class="cstat-no" title="statement not covered" >        debug chalk.grey util.inspect("#<span class="cstat-no" title="statement not covered" >{<span class="cstat-no" title="statement not covered" >proto</span>}://#{<span class="cstat-no" title="statement not covered" >path</span>}</span>") + " -&gt; result: ---"</span>
      return cb()
    if list.length
      debug chalk.grey util.inspect("#{proto}://#{path}") + " -&gt; result: #{util.inspect result}"
    # no reference in result
    <span class="missing-if-branch" title="else path not taken" >E</span>unless exists result
      return cb null, result unless list.length # stop if last entry of uri path
      work = object.extend {}, work
      work.data = result
      return find list, work, cb
    # check for retry
<span class="cstat-no" title="statement not covered" >    work.retry ?= 0</span>
<span class="cstat-no" title="statement not covered" >    if work.retry &gt; MAXRETRY/TIMEOUT</span>
<span class="cstat-no" title="statement not covered" >      work.spec.failed = true</span>
<span class="cstat-no" title="statement not covered" >      return throw Error <span class="cstat-no" title="statement not covered" >"Stopped because of circular references at</span></span>
      #{<span class="cstat-no" title="statement not covered" >work</span>.spec.name}/#{<span class="cstat-no" title="statement not covered" >work.path.join '/'</span>}"
    # retry the same call again
<span class="cstat-no" title="statement not covered" >    list.unshift def</span>
<span class="cstat-no" title="statement not covered" >    setTimeout <span class="fstat-no" title="function not covered" >-&gt;</span></span>
<span class="cstat-no" title="statement not covered" ><span class="cstat-no" title="statement not covered" >      return</span> if work.spec.failed</span> # processing already stopped
<span class="cstat-no" title="statement not covered" >      work.retry++</span>
<span class="cstat-no" title="statement not covered" >      find list, work, cb</span>
    , TIMEOUT
&nbsp;
# ### Find value of specific type
# This is a collection of methods for specific protocols.
findType =
  # #### Value checks
  check: (proto, path, work, cb) -&gt;
    # get the check schema reading as js
    vm = require 'vm'
    schema = vm.runInNewContext "x=#{path}"
    # run the subcheck
    name = work.spec?.name ? 'value'
    check.run
      name: name + '#ref'
      schema: schema
      value: work.data
    , (err, value) -&gt;
      <span class="missing-if-branch" title="if path not taken" >I</span>if err
<span class="cstat-no" title="statement not covered" >        debug chalk.grey <span class="cstat-no" title="statement not covered" >"'#{<span class="cstat-no" title="statement not covered" >proto</span>}://#{<span class="cstat-no" title="statement not covered" >path</span>}' -&gt; check failed: #{<span class="cstat-no" title="statement not covered" >err</span>.message}</span>"</span>
<span class="cstat-no" title="statement not covered" >        return cb()</span>
      cb null, value
  # #### Splitting of strings
  split: (proto, path, work, cb) -&gt;
    path = path[1..]
    splitter = path.split('//').map (s) -&gt; new RegExp s
    splitter.push '' if splitter.length is 1
    result = work.data.split(splitter[0]).map (t) -&gt;
      col = t.split splitter[1]
      col.unshift t
      col
    result.unshift null
    cb null, result
  # #### Matching strings
  match: (proto, path, work, cb) -&gt;
    re = path.match /\/([^]*)\/(i?)/
    re = new RegExp re[1], "#{re[2]}g"
    cb null, work.data.match re
  # #### Special parsing of string
  parse: (proto, path, work, cb) -&gt;
    switch path
      when '$js'
        vm = require 'vm'
        cb null, vm.runInNewContext "x=#{work.data}"
      when '$json'
        try
          result = JSON.parse work.data
        catch error
          debug chalk.grey "'#{proto}://#{path}' -&gt; check failed: #{error.message}"
          return cb()
        cb null, result
      when '$yaml'
        yaml = require 'js-yaml'
        try
          result = yaml.safeLoad work.data
        catch error
<span class="cstat-no" title="statement not covered" >          debug chalk.grey <span class="cstat-no" title="statement not covered" >"'#{<span class="cstat-no" title="statement not covered" >proto</span>}://#{<span class="cstat-no" title="statement not covered" >path</span>}' -&gt; check failed: #{<span class="cstat-no" title="statement not covered" >error</span>.message}</span>"</span>
<span class="cstat-no" title="statement not covered" >          return cb()</span>
        cb null, result
      when '$xml'
        xml2js = require 'xml2js'
        xml2js.parseString work.data, (err, result) -&gt;
          if err
            debug chalk.grey "'#{proto}://#{path}' -&gt; check failed: #{err.message}"
            return cb()
          cb null, result
      when '$auto'
        result = null
        async.detectSeries ['$yaml', '$xml', '$json', '$js'], (path, cb) -&gt;
          find [path], work, (err, val) -&gt;
            result = val
            cb()
        , -&gt;
          cb null, result
      else
<span class="cstat-no" title="statement not covered" ><span class="branch-5 cbranch-no" title="branch not covered" >        cb()</span></span>
  # #### Range selection in array
  range: (proto, path, work, cb) -&gt;
    # split multiple specifiers
    rows = path.match ///
      \d+ # first row
      (?:-\d+)? # end of row range
      (?:\[[^\]]+\])? # column specification
      ///g #path.split ','
    result = []
    # go over rows
    for row in rows
      row = row.match ///
        (\d+) # first row
        (?:-(\d+))? # end of row range
        (?:\[([^\]]+)\])? # column specification
        /// #path.split ','
      row.from = parseInt row[1]
      row.to = if row[2]? then parseInt row[2] else row.from
      cols = row[3]?.split ','
      if cols? and Array.isArray work.data[1]
        # get columns
        for drow in work.data[row.from..row.to]
          data = []
          for col in cols
            col = col.match ///
              (\d+) # first column
              (?:-(\d+))? # end of column range
              /// #path.split ','
            col.from = parseInt col[1]
            col.to = if col[2]? then parseInt col[2] else col.from
            data = data.concat drow[col.from..col.to]
          result.push data
      else
        # get single row
        for drow in work.data[row.from..row.to]
          result.push drow[0]
<span class="cstat-no" title="statement not covered" >    <span class="missing-if-branch" title="if path not taken" >I</span>return cb()</span> unless result.length
    result = result[0] if result.length is 1
    result = result[0] if result.length is 1
    cb null, result
  # #### Path selection in object
  object: (proto, path, work, cb) -&gt;
    cb null, object.pathSearch work.data, path
  # #### Join array together
  join: (proto, path, work, cb) -&gt;
    path = path[6..]
    splitter = if path then path.split '//' else [', ']
    cb null, arrayJoin work.data, splitter
  # #### Accessing environment variable
  env: (proto, path, work, cb) -&gt;
    cb null, process.env[path]
  # #### Read from value structure
  struct: (proto, path, work, cb) -&gt;
    findData path, work, cb
  # #### Read from additional context
  context: (proto, path, work, cb) -&gt;
    cb null, object.pathSearch work.spec?.context, path
  # #### Read from file
  file: (proto, path, work, cb) -&gt;
    fs = require 'alinex-fs'
    fspath = require 'path'
<span class="cstat-no" title="statement not covered" >    <span class="missing-if-branch" title="if path not taken" >I</span>path = fspath.resolve work.spec.dir, path</span> if work.spec?.dir?
    fs.realpath path, (err, path) -&gt;
      return cb err if err
      fs.readFile path, 'utf-8', cb
  # #### Read from web resource
  web: (proto, path, work, cb) -&gt;
    request = require 'request'
    request
      uri: "#{proto}://#{path}"
      followAllRedirects: true
    , (err, response, body) -&gt;
      # error checking
      return cb err if err
      if response.statusCode isnt 200
        return cb new Error "Server send wrong return code: #{response.statusCode}"
<span class="cstat-no" title="statement not covered" >      <span class="missing-if-branch" title="if path not taken" >I</span>return cb()</span> unless body?
      cb null, body
  # #### Read from command output
  cmd: (proto, path, work, cb) -&gt;
    exec = require('child_process').exec
    opt = {}
<span class="cstat-no" title="statement not covered" >    <span class="missing-if-branch" title="if path not taken" >I</span>opt.cwd = work.spec.dir</span> if work.spec?.dir?
    exec path, opt, (err, result) -&gt;
<span class="cstat-no" title="statement not covered" >      <span class="missing-if-branch" title="if path not taken" >I</span>return cb err</span> if err
      cb null, result.trim()
&nbsp;
# ### Read from value structure
findData = (path, work, cb) -&gt;
  # split path
  path = path.replace('/\/+$/', '').split /\/+/ if typeof path is 'string'
  work.path ?= []
  # find first level
  first = path[0]
  # absolute path, go on
  return cb null, object.pathSearch work.data, path[1..] if first is ''
  # search at current position
  skip = 0
  skip++ while path[skip] is '..'
  result = object.pathSearch work.data, work.path[0..work.path.length-skip-1].concat path[skip..]
  if result and work.spec?.done?
    checkpath = work.path[0..work.path.length-skip-1].concat(path[skip..]).join '/'
    unless checkpath in work.spec.done
      # check for retry
      work.retry ?= 0
      if work.retry &gt; MAXRETRY/TIMEOUT
        work.spec.failed = true
        return throw Error "Stopped because of uncheckable #{work.spec.name}/#{checkpath}"
      return setTimeout -&gt;
        return if work.spec.failed # processing already stopped
        work.retry++
        # reread value from spec
        work.data = work.spec.value
        findData path, work, cb
      , TIMEOUT
  return cb null, result if result
  # check if not at the end
  return cb() unless work.path.length
  # search neighbors by sub call on parent
  sub = object.clone work
  sub.spec = work.spec
  sub.path.pop()
  findData path, sub, cb
&nbsp;
# ### Recursively join array of arrays together
arrayJoin = (data, splitter) -&gt;
  glue = if splitter.length is 1 then splitter[0] else splitter.shift()
  result = ''
  for v in data
    v = arrayJoin v, splitter if Array.isArray v
    result += glue if result
    result += v
  result
&nbsp;</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Mon Apr 11 2016 15:58:04 GMT+0200 (CEST)
</div>
</div>
<script src="../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../sorter.js"></script>
</body>
</html>
