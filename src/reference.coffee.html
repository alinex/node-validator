<!DOCTYPE html>
<html>
<head>
  <title>reference.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../doc-style.css" />
  <script src="../doc-filelist.js"></script>
  <script>
    var relativeDir = "../", thisFile = "home/alex/github/node-validator/src/referencecoffee", defaultSidebar = true;
  </script>
  <script src="../doc-script.js"></script>
</head>
<body>
  <nav>
<div class="logo"><a href="http://alinex.github.io" onmouseover="lllogo.src='https://alinex.github.io/images/Alinex-200.png'" onmouseout="lllogo.src='https://alinex.github.io/images/Alinex-black-200.png'">
  <img name="lllogo" src="https://alinex.github.io/images/Alinex-black-200.png" width="150" title="Alinex Universe Homepage" />
  </a>
  <img src="http://alinex.github.io/images/Alinex-200.png" style="display:none" alt="preloading" />
</div>
<div class="links">
  <a href="http://alinex.github.io/blog" class="btn btn-primary"><span class="glyphicon-cog"></span> Blog</a>
  <a href="http://alinex.github.io/code.html" class="btn btn-warning"><span class="glyphicon-pencil"></span> Code</a>
</div>
</nav><div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">
      <div class="heading h1">
        <a href="#ip%20address%20validation">IP Address validation</a>
      </div>
      <div class="heading h2">
        <a href="#node%20modules">Node modules</a>
      </div>
      <div class="heading h2">
        <a href="#configuration">Configuration</a>
      </div>
      <div class="heading h2">
        <a href="#have%20references">Have references</a>
      </div>
      <div class="heading h2">
        <a href="#replace%20references">Replace references</a>
      </div>
      <div class="heading h2">
        <a href="#helper%20methods">Helper methods</a>
      </div>
      <div class="heading h3">
        <a href="#search%20through%20alternative%20sources">search through alternative sources</a>
      </div>
      <div class="heading h3">
        <a href="#find%20reference">Find reference</a>
      </div>
      <div class="heading h3">
        <a href="#find%20value%20of%20specific%20type">Find value of specific type</a>
      </div>
      <div class="heading h4">
        <a href="#value%20checks">Value checks</a>
      </div>
      <div class="heading h4">
        <a href="#splitting%20of%20strings">Splitting of strings</a>
      </div>
      <div class="heading h4">
        <a href="#matching%20strings">Matching strings</a>
      </div>
      <div class="heading h4">
        <a href="#special%20parsing%20of%20string">Special parsing of string</a>
      </div>
      <div class="heading h4">
        <a href="#range%20selection%20in%20array">Range selection in array</a>
      </div>
      <div class="heading h4">
        <a href="#path%20selection%20in%20object">Path selection in object</a>
      </div>
      <div class="heading h4">
        <a href="#join%20array%20together">Join array together</a>
      </div>
      <div class="heading h4">
        <a href="#accessing%20environment%20variable">Accessing environment variable</a>
      </div>
      <div class="heading h4">
        <a href="#read%20from%20value%20structure">Read from value structure</a>
      </div>
      <div class="heading h4">
        <a href="#read%20from%20additional%20context">Read from additional context</a>
      </div>
      <div class="heading h4">
        <a href="#read%20from%20file">Read from file</a>
      </div>
      <div class="heading h4">
        <a href="#read%20from%20web%20resource">Read from web resource</a>
      </div>
      <div class="heading h4">
        <a href="#read%20from%20command%20output">Read from command output</a>
      </div>
      <div class="heading h3">
        <a href="#read%20from%20value%20structure">Read from value structure</a>
      </div>
      <div class="heading h3">
        <a href="#recursively%20join%20array%20of%20arrays%20together">Recursively join array of arrays together</a>
      </div>
    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container" tabindex="0"><a id="fork" href="https://github.com/alinex/node-validator" title="Fork me on GitHub"></a><div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
      <tr>
        <td class="docs">
<div class="pilwrap" id="ip%20address%20validation">
  <h1>
    <a href="#ip%20address%20validation" name="ip%20address%20validation" class="pilcrow">&#182;</a>
    IP Address validation
  </h1>
</div>

        </td>
        <td class="code highlight"><div class="highlight"><pre></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2">&#182;</a>
</div>
<p>The following properties are used:</p>

<ul>
<li>spec - reference to the original validation call
<ul><li>name - (string) descriptive name of the data</li>
<li>schema - (object) structure to check</li>
<li>context - (object) additional data structure</li>
<li>dir - set to base directory for file relative file paths</li></ul></li>
<li>path - array containing the current path</li>
<li>pos - reference to schema position at this path</li>
<li>debug - output of current path for debugging</li>
<li>value - value at this path</li>
</ul>
        </td>
        <td class="code highlight"><div class="highlight"><pre>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3">&#182;</a>
</div>
<p>While working on the data the following values will be added:</p>

<ul>
<li>data - structure to work on (schema or context)</li>
<li>lastType - the type of the last checked reference to ensure security</li>
</ul>
        </td>
        <td class="code highlight"><div class="highlight"><pre>



</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="node%20modules">
  <h2>
    <a href="#node%20modules" name="node%20modules" class="pilcrow">&#182;</a>
    Node modules
  </h2>
</div>

        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nv">debug = </span><span class="nx">require</span><span class="p">(</span><span class="s">&#39;debug&#39;</span><span class="p">)(</span><span class="s">&#39;validator:reference&#39;</span><span class="p">)</span>
<span class="nv">util = </span><span class="nx">require</span> <span class="s">&#39;util&#39;</span>
<span class="nv">chalk = </span><span class="nx">require</span> <span class="s">&#39;chalk&#39;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5">&#182;</a>
</div>
<p>alinex modules</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nv">async = </span><span class="nx">require</span> <span class="s">&#39;alinex-async&#39;</span>
<span class="p">{</span><span class="nx">object</span><span class="p">}</span> <span class="o">=</span> <span class="nx">require</span> <span class="s">&#39;alinex-util&#39;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-6" id="section-6">&#182;</a>
</div>
<p>include classes and helper</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nv">check = </span><span class="nx">require</span> <span class="s">&#39;./check&#39;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="configuration">
  <h2>
    <a href="#configuration" name="configuration" class="pilcrow">&#182;</a>
    Configuration
  </h2>
</div>


<p>MAXRETRY defines the time to wait till the references should be solved</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nv">MAXRETRY = </span><span class="mi">10000</span> <span class="c1"># waiting for 10 seconds at max</span>
<span class="nv">TIMEOUT = </span><span class="mi">10</span> <span class="c1"># checking every 10ms</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-8" id="section-8">&#182;</a>
</div>
<p>defines specific type handler for some protocols</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nv">protocolMap =</span>
  <span class="nv">http: </span><span class="s">&#39;web&#39;</span>
  <span class="nv">https: </span><span class="s">&#39;web&#39;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-9" id="section-9">&#182;</a>
</div>
<p>to ensure security a reference can only call references with lower precedence</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nv">typePrecedence =</span>
  <span class="nv">env: </span><span class="mi">5</span>
  <span class="nv">struct: </span><span class="mi">4</span>
  <span class="nv">context: </span><span class="mi">3</span>
  <span class="nv">file: </span><span class="mi">2</span>
  <span class="nv">cmd: </span><span class="mi">2</span>
  <span class="nv">web: </span><span class="mi">1</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="have%20references">
  <h2>
    <a href="#have%20references" name="have%20references" class="pilcrow">&#182;</a>
    Have references
  </h2>
</div>


<p>Check if there are references in the object.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nv">exists = exports.exists = </span><span class="nf">(value) -&gt;</span>
  <span class="k">return</span> <span class="kc">false</span> <span class="k">unless</span> <span class="k">typeof</span> <span class="nx">value</span> <span class="o">is</span> <span class="s">&#39;string&#39;</span>
  <span class="nb">Boolean</span> <span class="nx">value</span><span class="p">.</span><span class="nx">match</span> <span class="sr">/&lt;&lt;&lt;[^]*&gt;&gt;&gt;/</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="replace%20references">
  <h2>
    <a href="#replace%20references" name="replace%20references" class="pilcrow">&#182;</a>
    Replace references
  </h2>
</div>


<p>This is called from the check to resolve the references first before running
the real check. If there are no references it will return immediately.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nv">exports.replace = </span><span class="nf">(value, work={}, cb) -&gt;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-12" id="section-12">&#182;</a>
</div>
<p>maybe called without work (mostly for)</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="k">if</span> <span class="k">typeof</span> <span class="nx">work</span> <span class="o">is</span> <span class="s">&#39;function&#39;</span>
    <span class="nv">cb = </span><span class="nx">work</span>
    <span class="nv">work = </span><span class="p">{}</span>
  <span class="k">return</span> <span class="nx">cb</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">value</span> <span class="k">unless</span> <span class="nx">exists</span> <span class="nx">value</span>
  <span class="nx">work</span><span class="p">.</span><span class="nx">data</span> <span class="o">?=</span> <span class="nx">work</span><span class="p">.</span><span class="nx">spec</span><span class="o">?</span><span class="p">.</span><span class="nx">value</span>
  <span class="nx">debug</span> <span class="s">&quot;replace </span><span class="si">#{</span><span class="nx">util</span><span class="p">.</span><span class="nx">inspect</span> <span class="nx">value</span><span class="si">}</span><span class="s">...&quot;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-13" id="section-13">&#182;</a>
</div>
<p>step over parts</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="nv">refs = </span><span class="nx">value</span><span class="p">.</span><span class="nx">split</span> <span class="sr">/(&lt;&lt;&lt;[^]*?&gt;&gt;&gt;)/</span>
  <span class="nv">refs = </span><span class="p">[</span><span class="nx">refs</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="k">if</span> <span class="nx">refs</span><span class="p">.</span><span class="nx">length</span> <span class="o">is</span> <span class="mi">3</span> <span class="o">and</span> <span class="nx">refs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">is</span> <span class="s">&#39;&#39;</span> <span class="o">and</span> <span class="nx">refs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">is</span> <span class="s">&#39;&#39;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-14" id="section-14">&#182;</a>
</div>
<p>check all references</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="nx">async</span><span class="p">.</span><span class="nx">map</span> <span class="nx">refs</span><span class="p">,</span> <span class="nf">(v, cb) -&gt;</span>
    <span class="nx">findAlternative</span> <span class="nx">v</span><span class="p">,</span> <span class="nx">work</span><span class="p">,</span> <span class="nx">cb</span>
  <span class="p">,</span> <span class="nf">(err, results) -&gt;</span>
    <span class="k">return</span> <span class="nx">cb</span><span class="p">()</span> <span class="k">if</span> <span class="nx">err</span>
    <span class="k">if</span> <span class="nx">results</span><span class="p">.</span><span class="nx">length</span> <span class="o">is</span> <span class="mi">1</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-15" id="section-15">&#182;</a>
</div>
<p>return first result if only one reference used</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="nx">debug</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">util</span><span class="p">.</span><span class="nx">inspect</span> <span class="nx">value</span><span class="si">}</span><span class="s"> is replaced by </span><span class="si">#{</span><span class="nx">util</span><span class="p">.</span><span class="nx">inspect</span> <span class="nx">results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s">&quot;</span>
      <span class="k">return</span> <span class="nx">cb</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-16" id="section-16">&#182;</a>
</div>
<p>combine reference together</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nv">result = </span><span class="nx">results</span><span class="p">.</span><span class="nx">join</span> <span class="s">&#39;&#39;</span>
    <span class="nx">debug</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">util</span><span class="p">.</span><span class="nx">inspect</span> <span class="nx">value</span><span class="si">}</span><span class="s"> is replaced by </span><span class="si">#{</span><span class="nx">util</span><span class="p">.</span><span class="nx">inspect</span> <span class="nx">result</span><span class="si">}</span><span class="s">&quot;</span>
    <span class="nx">cb</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">result</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="helper%20methods">
  <h2>
    <a href="#helper%20methods" name="helper%20methods" class="pilcrow">&#182;</a>
    Helper methods
  </h2>
</div>

        </td>
        <td class="code highlight"><div class="highlight"><pre>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="search%20through%20alternative%20sources">
  <h3>
    <a href="#search%20through%20alternative%20sources" name="search%20through%20alternative%20sources" class="pilcrow">&#182;</a>
    search through alternative sources
  </h3>
</div>


<p>Alternative sources are separated by <code>|</code> and the first possible alternative
should be used.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nv">findAlternative = </span><span class="nf">(value, work={}, cb) -&gt;</span>
  <span class="k">return</span> <span class="nx">cb</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">value</span> <span class="k">unless</span> <span class="o">~</span><span class="nx">value</span><span class="p">.</span><span class="nx">indexOf</span> <span class="s">&#39;&lt;&lt;&lt;&#39;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-19" id="section-19">&#182;</a>
</div>
<p>replace &lt;&lt;&lt; and >>> and split into alternatives</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="nv">first = </span><span class="kc">true</span>
  <span class="nx">async</span><span class="p">.</span><span class="nx">map</span> <span class="nx">value</span><span class="p">[</span><span class="mi">3</span><span class="p">..</span><span class="o">-</span><span class="mi">4</span><span class="p">].</span><span class="nx">split</span><span class="p">(</span><span class="sr">/\s+\|\s+/</span><span class="p">),</span> <span class="nf">(alt, cb) -&gt;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-20" id="section-20">&#182;</a>
</div>
<p>automatically set first element to <code>struct</code> if no other protocol set</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">if</span> <span class="nx">first</span> <span class="o">and</span> <span class="o">not</span> <span class="o">~</span><span class="nx">alt</span><span class="p">.</span><span class="nx">indexOf</span> <span class="s">&#39;://&#39;</span>
      <span class="nv">alt = </span><span class="s">&quot;struct://</span><span class="si">#{</span><span class="nx">alt</span><span class="si">}</span><span class="s">&quot;</span>
    <span class="nv">first = </span><span class="kc">false</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-21" id="section-21">&#182;</a>
</div>
<p>split uri into anchored separated paths</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nv">alt = </span><span class="nx">alt</span><span class="p">[</span><span class="mi">0</span><span class="p">..</span><span class="nx">alt</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="k">while</span> <span class="nx">alt</span><span class="p">[</span><span class="nx">alt</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">is</span> <span class="s">&#39;#&#39;</span>
    <span class="nv">uriPart = </span><span class="nx">alt</span><span class="p">.</span><span class="nx">split</span> <span class="sr">/#/</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-22" id="section-22">&#182;</a>
</div>
<p>return default value</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">if</span> <span class="nx">uriPart</span><span class="p">.</span><span class="nx">length</span> <span class="o">is</span> <span class="mi">1</span> <span class="o">and</span> <span class="o">not</span> <span class="o">~</span><span class="nx">alt</span><span class="p">.</span><span class="nx">indexOf</span> <span class="s">&#39;://&#39;</span>
      <span class="nx">debug</span> <span class="nx">chalk</span><span class="p">.</span><span class="nx">grey</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">util</span><span class="p">.</span><span class="nx">inspect</span> <span class="nx">alt</span><span class="si">}</span><span class="s"> -&gt; default value: </span><span class="si">#{</span><span class="nx">util</span><span class="p">.</span><span class="nx">inspect</span> <span class="nx">alt</span><span class="si">}</span><span class="s">&quot;</span>
      <span class="k">return</span> <span class="nx">cb</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">alt</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-23" id="section-23">&#182;</a>
</div>
<p>read value from given uri parts</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">find</span> <span class="nx">uriPart</span><span class="p">,</span> <span class="nx">work</span><span class="p">,</span> <span class="nf">(err, result) -&gt;</span>
      <span class="k">if</span> <span class="nx">err</span>
        <span class="nx">debug</span> <span class="nx">chalk</span><span class="p">.</span><span class="nx">grey</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">util</span><span class="p">.</span><span class="nx">inspect</span> <span class="nx">alt</span><span class="si">}</span><span class="s"> -&gt; failed: </span><span class="si">#{</span><span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="si">}</span><span class="s">&quot;</span>
        <span class="k">return</span> <span class="nx">cb</span> <span class="nx">err</span>
      <span class="nx">debug</span> <span class="nx">chalk</span><span class="p">.</span><span class="nx">grey</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">util</span><span class="p">.</span><span class="nx">inspect</span> <span class="nx">alt</span><span class="si">}</span><span class="s"> -&gt; result: </span><span class="si">#{</span><span class="nx">util</span><span class="p">.</span><span class="nx">inspect</span> <span class="nx">result</span><span class="si">}</span><span class="s">&quot;</span>
      <span class="nx">cb</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">result</span>
  <span class="p">,</span> <span class="nf">(err, results) -&gt;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-24" id="section-24">&#182;</a>
</div>
<p>find first alternative</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">for</span> <span class="nx">result</span> <span class="k">in</span> <span class="nx">results</span>
      <span class="k">return</span> <span class="nx">cb</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">result</span> <span class="k">if</span> <span class="nx">result</span><span class="o">?</span>
    <span class="nx">cb</span><span class="p">()</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="find%20reference">
  <h3>
    <a href="#find%20reference" name="find%20reference" class="pilcrow">&#182;</a>
    Find reference
  </h3>
</div>


<p>This method is called with all the uri parts as list and will search the
value of the first uri part, pass it on to the second search as data and so
on. The result will be from the last uri path.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nv">find = </span><span class="nf">(list, work={}, cb) -&gt;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-26" id="section-26">&#182;</a>
</div>
<p>get type of uri part</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="nv">def = </span><span class="nx">list</span><span class="p">.</span><span class="nx">shift</span><span class="p">()</span>
  <span class="k">return</span> <span class="nx">cb</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">work</span><span class="p">.</span><span class="nx">data</span> <span class="k">unless</span> <span class="nx">def</span> <span class="c1"># empty anchor</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-27" id="section-27">&#182;</a>
</div>
<p>detect protocol</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="p">[</span><span class="nx">proto</span><span class="p">,</span> <span class="nx">path</span><span class="p">]</span> <span class="o">=</span> <span class="nx">def</span><span class="p">.</span><span class="nx">split</span> <span class="sr">/:\/\//</span>
  <span class="nx">path</span> <span class="o">?=</span> <span class="nx">proto</span>
  <span class="nv">proto = </span><span class="k">switch</span> <span class="nx">proto</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">when</span> <span class="s">&#39;{&#39;</span> <span class="k">then</span> <span class="s">&#39;check&#39;</span>
    <span class="k">when</span> <span class="s">&#39;%&#39;</span> <span class="k">then</span> <span class="s">&#39;split&#39;</span>
    <span class="k">when</span> <span class="s">&#39;/&#39;</span> <span class="k">then</span> <span class="s">&#39;match&#39;</span>
    <span class="k">when</span> <span class="s">&#39;$&#39;</span> <span class="k">then</span> <span class="s">&#39;parse&#39;</span>
    <span class="k">else</span>
      <span class="k">if</span> <span class="nx">def</span><span class="p">.</span><span class="nx">match</span> <span class="sr">/^\d/</span> <span class="k">then</span> <span class="s">&#39;range&#39;</span>
      <span class="k">else</span> <span class="k">unless</span> <span class="o">~</span><span class="nx">def</span><span class="p">.</span><span class="nx">indexOf</span> <span class="s">&#39;://&#39;</span>  <span class="k">then</span> <span class="s">&#39;object&#39;</span>
      <span class="k">else</span> <span class="nx">proto</span>
  <span class="k">if</span> <span class="nx">proto</span> <span class="o">is</span> <span class="s">&#39;parse&#39;</span> <span class="o">and</span> <span class="o">~</span><span class="nx">path</span><span class="p">.</span><span class="nx">indexOf</span> <span class="s">&#39;$join&#39;</span>
    <span class="nv">proto = </span><span class="s">&#39;join&#39;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-28" id="section-28">&#182;</a>
</div>
<p>return if not possible without data (incorrect use)</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="k">return</span> <span class="nx">cb</span><span class="p">()</span> <span class="k">if</span> <span class="nx">def</span><span class="p">[</span><span class="mi">0</span><span class="p">..</span><span class="nx">proto</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">isnt</span> <span class="nx">proto</span> <span class="o">and</span> <span class="o">not</span> <span class="nx">work</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-29" id="section-29">&#182;</a>
</div>
<p>run automatic conversion of data if needed</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="k">switch</span>
    <span class="k">when</span> <span class="k">typeof</span> <span class="nx">work</span><span class="p">.</span><span class="nx">data</span> <span class="o">is</span> <span class="s">&#39;string&#39;</span>
      <span class="k">switch</span> <span class="nx">proto</span>
        <span class="k">when</span> <span class="s">&#39;range&#39;</span>
          <span class="nx">list</span><span class="p">.</span><span class="nx">unshift</span> <span class="nx">def</span>
          <span class="nv">proto = </span><span class="s">&#39;split&#39;</span>
          <span class="nv">path = </span><span class="s">&#39;%\n&#39;</span>
        <span class="k">when</span> <span class="s">&#39;object&#39;</span>
          <span class="nx">list</span><span class="p">.</span><span class="nx">unshift</span> <span class="nx">def</span>
          <span class="nv">proto = </span><span class="s">&#39;parse&#39;</span>
          <span class="nv">path = </span><span class="s">&#39;$auto&#39;</span>
    <span class="k">when</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span> <span class="nx">work</span><span class="p">.</span><span class="nx">data</span>
      <span class="k">switch</span> <span class="nx">proto</span>
        <span class="k">when</span> <span class="s">&#39;object&#39;</span><span class="p">,</span> <span class="s">&#39;split&#39;</span><span class="p">,</span> <span class="s">&#39;match&#39;</span>
          <span class="nx">list</span><span class="p">.</span><span class="nx">unshift</span> <span class="nx">def</span>
          <span class="nv">proto = </span><span class="s">&#39;join&#39;</span>
          <span class="nv">path = </span><span class="s">&#39;$join&#39;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-30" id="section-30">&#182;</a>
</div>
<p>check for impossible result data</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="k">if</span> <span class="p">(</span>
    <span class="p">(</span><span class="o">not</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">work</span><span class="p">.</span><span class="nx">data</span><span class="p">)</span> <span class="o">and</span> <span class="nx">proto</span> <span class="k">in</span> <span class="p">[</span><span class="s">&#39;range&#39;</span><span class="p">,</span> <span class="s">&#39;join&#39;</span><span class="p">])</span> <span class="o">or</span>
    <span class="p">(</span><span class="k">typeof</span> <span class="nx">work</span><span class="p">.</span><span class="nx">data</span> <span class="o">isnt</span> <span class="s">&#39;string&#39;</span> <span class="o">and</span> <span class="nx">proto</span> <span class="k">in</span> <span class="p">[</span><span class="s">&#39;split&#39;</span><span class="p">,</span> <span class="s">&#39;match&#39;</span><span class="p">,</span> <span class="s">&#39;parse&#39;</span><span class="p">])</span> <span class="o">or</span>
    <span class="p">(</span><span class="k">typeof</span> <span class="nx">work</span><span class="p">.</span><span class="nx">data</span> <span class="o">isnt</span> <span class="s">&#39;object&#39;</span> <span class="o">and</span> <span class="nx">proto</span> <span class="o">is</span> <span class="s">&#39;object&#39;</span><span class="p">)</span>
    <span class="p">)</span>
      <span class="nx">debug</span> <span class="nx">chalk</span><span class="p">.</span><span class="nx">grey</span> <span class="s">&quot;stop at part </span><span class="si">#{</span><span class="nx">proto</span><span class="si">}</span><span class="s">://</span><span class="si">#{</span><span class="nx">path</span><span class="si">}</span><span class="s"> because wrong result type&quot;</span>
      <span class="k">return</span> <span class="nx">cb</span><span class="p">()</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-31" id="section-31">&#182;</a>
</div>
<p>find type handler</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="nv">proto = </span><span class="nx">proto</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span>
  <span class="nv">type = </span><span class="nx">protocolMap</span><span class="p">[</span><span class="nx">proto</span><span class="p">]</span> <span class="o">?</span> <span class="nx">proto</span>
  <span class="nx">debug</span> <span class="nx">chalk</span><span class="p">.</span><span class="nx">grey</span> <span class="s">&quot;check part &quot;</span> <span class="o">+</span> <span class="nx">util</span><span class="p">.</span><span class="nx">inspect</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">proto</span><span class="si">}</span><span class="s">://</span><span class="si">#{</span><span class="nx">path</span><span class="si">}</span><span class="s">&quot;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-32" id="section-32">&#182;</a>
</div>
<p>check for correct handler</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="k">unless</span> <span class="nx">findType</span><span class="p">[</span><span class="nx">type</span><span class="p">]</span><span class="o">?</span>
    <span class="k">return</span> <span class="nx">cb</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s">&quot;No handler for protocol </span><span class="si">#{</span><span class="nx">proto</span><span class="si">}</span><span class="s"> for references defined&quot;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-33" id="section-33">&#182;</a>
</div>
<p>check precedence for next uri</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="k">if</span> <span class="nx">work</span><span class="p">.</span><span class="nx">lastType</span><span class="o">?</span> <span class="o">and</span> <span class="nx">typePrecedence</span><span class="p">[</span><span class="nx">type</span><span class="p">]</span> <span class="o">&gt;</span> <span class="nx">typePrecedence</span><span class="p">[</span><span class="nx">work</span><span class="p">.</span><span class="nx">lastType</span><span class="o">?</span><span class="p">]</span>
    <span class="k">return</span> <span class="nx">cb</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">type</span><span class="si">}</span><span class="s">-reference can not be called from </span><span class="si">#{</span><span class="nx">proto</span><span class="si">}</span><span class="s">-reference</span>
<span class="s">    for security reasons&quot;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-34" id="section-34">&#182;</a>
</div>
<p>run type handler and return if nothing found</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="nv">work.lastType = </span><span class="nx">type</span>
  <span class="nx">findType</span><span class="p">[</span><span class="nx">type</span><span class="p">]</span> <span class="nx">proto</span><span class="p">,</span> <span class="nx">path</span><span class="p">,</span> <span class="nx">work</span><span class="p">,</span> <span class="nf">(err, result) -&gt;</span>
    <span class="k">return</span> <span class="nx">cb</span> <span class="nx">err</span> <span class="k">if</span> <span class="nx">err</span>
    <span class="k">unless</span> <span class="nx">result</span> <span class="c1"># no result so stop this uri</span>
      <span class="k">if</span> <span class="nx">list</span><span class="p">.</span><span class="nx">length</span>
        <span class="nx">debug</span> <span class="nx">chalk</span><span class="p">.</span><span class="nx">grey</span> <span class="nx">util</span><span class="p">.</span><span class="nx">inspect</span><span class="p">(</span><span class="s">&quot;</span><span class="si">#{</span><span class="nx">proto</span><span class="si">}</span><span class="s">://</span><span class="si">#{</span><span class="nx">path</span><span class="si">}</span><span class="s">&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot; -&gt; result: ---&quot;</span>
      <span class="k">return</span> <span class="nx">cb</span><span class="p">()</span>
    <span class="k">if</span> <span class="nx">list</span><span class="p">.</span><span class="nx">length</span>
      <span class="nx">debug</span> <span class="nx">chalk</span><span class="p">.</span><span class="nx">grey</span> <span class="nx">util</span><span class="p">.</span><span class="nx">inspect</span><span class="p">(</span><span class="s">&quot;</span><span class="si">#{</span><span class="nx">proto</span><span class="si">}</span><span class="s">://</span><span class="si">#{</span><span class="nx">path</span><span class="si">}</span><span class="s">&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot; -&gt; result: </span><span class="si">#{</span><span class="nx">util</span><span class="p">.</span><span class="nx">inspect</span> <span class="nx">result</span><span class="si">}</span><span class="s">&quot;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-35" id="section-35">&#182;</a>
</div>
<p>no reference in result</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">unless</span> <span class="nx">exists</span> <span class="nx">result</span>
      <span class="k">return</span> <span class="nx">cb</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">result</span> <span class="k">unless</span> <span class="nx">list</span><span class="p">.</span><span class="nx">length</span> <span class="c1"># stop if last entry of uri path</span>
      <span class="nv">work = </span><span class="nx">object</span><span class="p">.</span><span class="nx">extend</span> <span class="p">{},</span> <span class="nx">work</span>
      <span class="nv">work.data = </span><span class="nx">result</span>
      <span class="k">return</span> <span class="nx">find</span> <span class="nx">list</span><span class="p">,</span> <span class="nx">work</span><span class="p">,</span> <span class="nx">cb</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-36" id="section-36">&#182;</a>
</div>
<p>check for retry</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">work</span><span class="p">.</span><span class="nx">retry</span> <span class="o">?=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="nx">work</span><span class="p">.</span><span class="nx">retry</span> <span class="o">&gt;</span> <span class="nx">MAXRETRY</span><span class="o">/</span><span class="nx">TIMEOUT</span>
      <span class="nv">work.spec.failed = </span><span class="kc">true</span>
      <span class="k">return</span> <span class="k">throw</span> <span class="nb">Error</span> <span class="s">&quot;Stopped because of circular references at</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-37" id="section-37">&#182;</a>
</div>
<p>{work.spec.name}/#{work.path.join '/'}"
retry the same call again</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="s">    list.unshift def</span>
<span class="s">    setTimeout -&gt;</span>
<span class="s">      return if work.spec.failed </span><span class="err">#</span><span class="s"> processing already stopped</span>
<span class="s">      work.retry++</span>
<span class="s">      find list, work, cb</span>
<span class="s">    , TIMEOUT</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="find%20value%20of%20specific%20type">
  <h3>
    <a href="#find%20value%20of%20specific%20type" name="find%20value%20of%20specific%20type" class="pilcrow">&#182;</a>
    Find value of specific type
  </h3>
</div>


<p>This is a collection of methods for specific protocols.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="s">findType =</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="value%20checks">
  <h4>
    <a href="#value%20checks" name="value%20checks" class="pilcrow">&#182;</a>
    Value checks
  </h4>
</div>

        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="s">  check: (proto, path, work, cb) -&gt;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-40" id="section-40">&#182;</a>
</div>
<p>get the check schema reading as js</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="s">    vm = require &#39;vm&#39;</span>
<span class="s">    schema = vm.runInNewContext &quot;</span><span class="nx">x</span><span class="o">=</span><span class="c1">#{path}&quot;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-41" id="section-41">&#182;</a>
</div>
<p>run the subcheck</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nv">name = </span><span class="nx">work</span><span class="p">.</span><span class="nx">spec</span><span class="o">?</span><span class="p">.</span><span class="nx">name</span> <span class="o">?</span> <span class="s">&#39;value&#39;</span>
    <span class="nx">check</span><span class="p">.</span><span class="nx">run</span>
      <span class="nv">name: </span><span class="nx">name</span> <span class="o">+</span> <span class="s">&#39;#ref&#39;</span>
      <span class="nv">schema: </span><span class="nx">schema</span>
      <span class="nv">value: </span><span class="nx">work</span><span class="p">.</span><span class="nx">data</span>
    <span class="p">,</span> <span class="nf">(err, value) -&gt;</span>
      <span class="k">if</span> <span class="nx">err</span>
        <span class="nx">debug</span> <span class="nx">chalk</span><span class="p">.</span><span class="nx">grey</span> <span class="s">&quot;&#39;</span><span class="si">#{</span><span class="nx">proto</span><span class="si">}</span><span class="s">://</span><span class="si">#{</span><span class="nx">path</span><span class="si">}</span><span class="s">&#39; -&gt; check failed: </span><span class="si">#{</span><span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="si">}</span><span class="s">&quot;</span>
        <span class="k">return</span> <span class="nx">cb</span><span class="p">()</span>
      <span class="nx">cb</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">value</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="splitting%20of%20strings">
  <h4>
    <a href="#splitting%20of%20strings" name="splitting%20of%20strings" class="pilcrow">&#182;</a>
    Splitting of strings
  </h4>
</div>

        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="nv">split: </span><span class="nf">(proto, path, work, cb) -&gt;</span>
    <span class="nv">path = </span><span class="nx">path</span><span class="p">[</span><span class="mi">1</span><span class="p">..]</span>
    <span class="nv">splitter = </span><span class="nx">path</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s">&#39;//&#39;</span><span class="p">).</span><span class="nx">map</span> <span class="nf">(s) -&gt;</span> <span class="k">new</span> <span class="nb">RegExp</span> <span class="nx">s</span>
    <span class="nx">splitter</span><span class="p">.</span><span class="nx">push</span> <span class="s">&#39;&#39;</span> <span class="k">if</span> <span class="nx">splitter</span><span class="p">.</span><span class="nx">length</span> <span class="o">is</span> <span class="mi">1</span>
    <span class="nv">result = </span><span class="nx">work</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="nx">splitter</span><span class="p">[</span><span class="mi">0</span><span class="p">]).</span><span class="nx">map</span> <span class="nf">(t) -&gt;</span>
      <span class="nv">col = </span><span class="nx">t</span><span class="p">.</span><span class="nx">split</span> <span class="nx">splitter</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
      <span class="nx">col</span><span class="p">.</span><span class="nx">unshift</span> <span class="nx">t</span>
      <span class="nx">col</span>
    <span class="nx">result</span><span class="p">.</span><span class="nx">unshift</span> <span class="kc">null</span>
    <span class="nx">cb</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">result</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="matching%20strings">
  <h4>
    <a href="#matching%20strings" name="matching%20strings" class="pilcrow">&#182;</a>
    Matching strings
  </h4>
</div>

        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="nv">match: </span><span class="nf">(proto, path, work, cb) -&gt;</span>
    <span class="nv">re = </span><span class="nx">path</span><span class="p">.</span><span class="nx">match</span> <span class="sr">/\/([^]*)\/(i?)/</span>
    <span class="nv">re = </span><span class="k">new</span> <span class="nb">RegExp</span> <span class="nx">re</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">re</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s">g&quot;</span>
    <span class="nx">cb</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">work</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">match</span> <span class="nx">re</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="special%20parsing%20of%20string">
  <h4>
    <a href="#special%20parsing%20of%20string" name="special%20parsing%20of%20string" class="pilcrow">&#182;</a>
    Special parsing of string
  </h4>
</div>

        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="nv">parse: </span><span class="nf">(proto, path, work, cb) -&gt;</span>
    <span class="k">switch</span> <span class="nx">path</span>
      <span class="k">when</span> <span class="s">&#39;$js&#39;</span>
        <span class="nv">vm = </span><span class="nx">require</span> <span class="s">&#39;vm&#39;</span>
        <span class="nx">cb</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">vm</span><span class="p">.</span><span class="nx">runInNewContext</span> <span class="s">&quot;x=</span><span class="si">#{</span><span class="nx">work</span><span class="p">.</span><span class="nx">data</span><span class="si">}</span><span class="s">&quot;</span>
      <span class="k">when</span> <span class="s">&#39;$json&#39;</span>
        <span class="k">try</span>
          <span class="nv">result = </span><span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span> <span class="nx">work</span><span class="p">.</span><span class="nx">data</span>
        <span class="k">catch</span> <span class="nx">error</span>
          <span class="nx">debug</span> <span class="nx">chalk</span><span class="p">.</span><span class="nx">grey</span> <span class="s">&quot;&#39;</span><span class="si">#{</span><span class="nx">proto</span><span class="si">}</span><span class="s">://</span><span class="si">#{</span><span class="nx">path</span><span class="si">}</span><span class="s">&#39; -&gt; check failed: </span><span class="si">#{</span><span class="nx">error</span><span class="p">.</span><span class="nx">message</span><span class="si">}</span><span class="s">&quot;</span>
          <span class="k">return</span> <span class="nx">cb</span><span class="p">()</span>
        <span class="nx">cb</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">result</span>
      <span class="k">when</span> <span class="s">&#39;$yaml&#39;</span>
        <span class="nv">yaml = </span><span class="nx">require</span> <span class="s">&#39;js-yaml&#39;</span>
        <span class="k">try</span>
          <span class="nv">result = </span><span class="nx">yaml</span><span class="p">.</span><span class="nx">safeLoad</span> <span class="nx">work</span><span class="p">.</span><span class="nx">data</span>
        <span class="k">catch</span> <span class="nx">error</span>
          <span class="nx">debug</span> <span class="nx">chalk</span><span class="p">.</span><span class="nx">grey</span> <span class="s">&quot;&#39;</span><span class="si">#{</span><span class="nx">proto</span><span class="si">}</span><span class="s">://</span><span class="si">#{</span><span class="nx">path</span><span class="si">}</span><span class="s">&#39; -&gt; check failed: </span><span class="si">#{</span><span class="nx">error</span><span class="p">.</span><span class="nx">message</span><span class="si">}</span><span class="s">&quot;</span>
          <span class="k">return</span> <span class="nx">cb</span><span class="p">()</span>
        <span class="nx">cb</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">result</span>
      <span class="k">when</span> <span class="s">&#39;$xml&#39;</span>
        <span class="nv">xml2js = </span><span class="nx">require</span> <span class="s">&#39;xml2js&#39;</span>
        <span class="nx">xml2js</span><span class="p">.</span><span class="nx">parseString</span> <span class="nx">work</span><span class="p">.</span><span class="nx">data</span><span class="p">,</span> <span class="nf">(err, result) -&gt;</span>
          <span class="k">if</span> <span class="nx">err</span>
            <span class="nx">debug</span> <span class="nx">chalk</span><span class="p">.</span><span class="nx">grey</span> <span class="s">&quot;&#39;</span><span class="si">#{</span><span class="nx">proto</span><span class="si">}</span><span class="s">://</span><span class="si">#{</span><span class="nx">path</span><span class="si">}</span><span class="s">&#39; -&gt; check failed: </span><span class="si">#{</span><span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="si">}</span><span class="s">&quot;</span>
            <span class="k">return</span> <span class="nx">cb</span><span class="p">()</span>
          <span class="nx">cb</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">result</span>
      <span class="k">when</span> <span class="s">&#39;$auto&#39;</span>
        <span class="nv">result = </span><span class="kc">null</span>
        <span class="nx">async</span><span class="p">.</span><span class="nx">detectSeries</span> <span class="p">[</span><span class="s">&#39;$yaml&#39;</span><span class="p">,</span> <span class="s">&#39;$xml&#39;</span><span class="p">,</span> <span class="s">&#39;$json&#39;</span><span class="p">,</span> <span class="s">&#39;$js&#39;</span><span class="p">],</span> <span class="nf">(path, cb) -&gt;</span>
          <span class="nx">find</span> <span class="p">[</span><span class="nx">path</span><span class="p">],</span> <span class="nx">work</span><span class="p">,</span> <span class="nf">(err, val) -&gt;</span>
            <span class="nv">result = </span><span class="nx">val</span>
            <span class="nx">cb</span><span class="p">()</span>
        <span class="p">,</span> <span class="nf">-&gt;</span>
          <span class="nx">cb</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">result</span>
      <span class="k">else</span>
        <span class="nx">cb</span><span class="p">()</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="range%20selection%20in%20array">
  <h4>
    <a href="#range%20selection%20in%20array" name="range%20selection%20in%20array" class="pilcrow">&#182;</a>
    Range selection in array
  </h4>
</div>

        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="nv">range: </span><span class="nf">(proto, path, work, cb) -&gt;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-46" id="section-46">&#182;</a>
</div>
<p>split multiple specifiers</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nv">rows = </span><span class="nx">path</span><span class="p">.</span><span class="nx">match</span> <span class="sr">///</span>
<span class="sr">      \d+ # first row</span>
<span class="sr">      (?:-\d+)? # end of row range</span>
<span class="sr">      (?:\[[^\]]+\])? # column specification</span>
<span class="sr">      ///g</span> <span class="c1">#path.split &#39;,&#39;</span>
    <span class="nv">result = </span><span class="p">[]</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-47" id="section-47">&#182;</a>
</div>
<p>go over rows</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">for</span> <span class="nx">row</span> <span class="k">in</span> <span class="nx">rows</span>
      <span class="nv">row = </span><span class="nx">row</span><span class="p">.</span><span class="nx">match</span> <span class="sr">///</span>
<span class="sr">        (\d+) # first row</span>
<span class="sr">        (?:-(\d+))? # end of row range</span>
<span class="sr">        (?:\[([^\]]+)\])? # column specification</span>
<span class="sr">        ///</span> <span class="c1">#path.split &#39;,&#39;</span>
      <span class="nv">row.from = </span><span class="nb">parseInt</span> <span class="nx">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
      <span class="nv">row.to = </span><span class="k">if</span> <span class="nx">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">?</span> <span class="k">then</span> <span class="nb">parseInt</span> <span class="nx">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">else</span> <span class="nx">row</span><span class="p">.</span><span class="nx">from</span>
      <span class="nv">cols = </span><span class="nx">row</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">?</span><span class="p">.</span><span class="nx">split</span> <span class="s">&#39;,&#39;</span>
      <span class="k">if</span> <span class="nx">cols</span><span class="o">?</span> <span class="o">and</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span> <span class="nx">work</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-48" id="section-48">&#182;</a>
</div>
<p>get columns</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="k">for</span> <span class="nx">drow</span> <span class="k">in</span> <span class="nx">work</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="nx">row</span><span class="p">.</span><span class="nx">from</span><span class="p">..</span><span class="nx">row</span><span class="p">.</span><span class="nx">to</span><span class="p">]</span>
          <span class="nv">data = </span><span class="p">[]</span>
          <span class="k">for</span> <span class="nx">col</span> <span class="k">in</span> <span class="nx">cols</span>
            <span class="nv">col = </span><span class="nx">col</span><span class="p">.</span><span class="nx">match</span> <span class="sr">///</span>
<span class="sr">              (\d+) # first column</span>
<span class="sr">              (?:-(\d+))? # end of column range</span>
<span class="sr">              ///</span> <span class="c1">#path.split &#39;,&#39;</span>
            <span class="nv">col.from = </span><span class="nb">parseInt</span> <span class="nx">col</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="nv">col.to = </span><span class="k">if</span> <span class="nx">col</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">?</span> <span class="k">then</span> <span class="nb">parseInt</span> <span class="nx">col</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">else</span> <span class="nx">col</span><span class="p">.</span><span class="nx">from</span>
            <span class="nv">data = </span><span class="nx">data</span><span class="p">.</span><span class="nx">concat</span> <span class="nx">drow</span><span class="p">[</span><span class="nx">col</span><span class="p">.</span><span class="nx">from</span><span class="p">..</span><span class="nx">col</span><span class="p">.</span><span class="nx">to</span><span class="p">]</span>
          <span class="nx">result</span><span class="p">.</span><span class="nx">push</span> <span class="nx">data</span>
      <span class="k">else</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-49" id="section-49">&#182;</a>
</div>
<p>get single row</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="k">for</span> <span class="nx">drow</span> <span class="k">in</span> <span class="nx">work</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="nx">row</span><span class="p">.</span><span class="nx">from</span><span class="p">..</span><span class="nx">row</span><span class="p">.</span><span class="nx">to</span><span class="p">]</span>
          <span class="nx">result</span><span class="p">.</span><span class="nx">push</span> <span class="nx">drow</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="nx">cb</span><span class="p">()</span> <span class="k">unless</span> <span class="nx">result</span><span class="p">.</span><span class="nx">length</span>
    <span class="nv">result = </span><span class="nx">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nx">result</span><span class="p">.</span><span class="nx">length</span> <span class="o">is</span> <span class="mi">1</span>
    <span class="nv">result = </span><span class="nx">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nx">result</span><span class="p">.</span><span class="nx">length</span> <span class="o">is</span> <span class="mi">1</span>
    <span class="nx">cb</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">result</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="path%20selection%20in%20object">
  <h4>
    <a href="#path%20selection%20in%20object" name="path%20selection%20in%20object" class="pilcrow">&#182;</a>
    Path selection in object
  </h4>
</div>

        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="nv">object: </span><span class="nf">(proto, path, work, cb) -&gt;</span>
    <span class="nx">cb</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">object</span><span class="p">.</span><span class="nx">pathSearch</span> <span class="nx">work</span><span class="p">.</span><span class="nx">data</span><span class="p">,</span> <span class="nx">path</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="join%20array%20together">
  <h4>
    <a href="#join%20array%20together" name="join%20array%20together" class="pilcrow">&#182;</a>
    Join array together
  </h4>
</div>

        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="nv">join: </span><span class="nf">(proto, path, work, cb) -&gt;</span>
    <span class="nv">path = </span><span class="nx">path</span><span class="p">[</span><span class="mi">6</span><span class="p">..]</span>
    <span class="nv">splitter = </span><span class="k">if</span> <span class="nx">path</span> <span class="k">then</span> <span class="nx">path</span><span class="p">.</span><span class="nx">split</span> <span class="s">&#39;//&#39;</span> <span class="k">else</span> <span class="p">[</span><span class="s">&#39;, &#39;</span><span class="p">]</span>
    <span class="nx">cb</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">arrayJoin</span> <span class="nx">work</span><span class="p">.</span><span class="nx">data</span><span class="p">,</span> <span class="nx">splitter</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="accessing%20environment%20variable">
  <h4>
    <a href="#accessing%20environment%20variable" name="accessing%20environment%20variable" class="pilcrow">&#182;</a>
    Accessing environment variable
  </h4>
</div>

        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="nv">env: </span><span class="nf">(proto, path, work, cb) -&gt;</span>
    <span class="nx">cb</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">[</span><span class="nx">path</span><span class="p">]</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="read%20from%20value%20structure">
  <h4>
    <a href="#read%20from%20value%20structure" name="read%20from%20value%20structure" class="pilcrow">&#182;</a>
    Read from value structure
  </h4>
</div>

        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="nv">struct: </span><span class="nf">(proto, path, work, cb) -&gt;</span>
    <span class="nx">findData</span> <span class="nx">path</span><span class="p">,</span> <span class="nx">work</span><span class="p">,</span> <span class="nx">cb</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="read%20from%20additional%20context">
  <h4>
    <a href="#read%20from%20additional%20context" name="read%20from%20additional%20context" class="pilcrow">&#182;</a>
    Read from additional context
  </h4>
</div>

        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="nv">context: </span><span class="nf">(proto, path, work, cb) -&gt;</span>
    <span class="nx">cb</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">object</span><span class="p">.</span><span class="nx">pathSearch</span> <span class="nx">work</span><span class="p">.</span><span class="nx">spec</span><span class="o">?</span><span class="p">.</span><span class="nx">context</span><span class="p">,</span> <span class="nx">path</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="read%20from%20file">
  <h4>
    <a href="#read%20from%20file" name="read%20from%20file" class="pilcrow">&#182;</a>
    Read from file
  </h4>
</div>

        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="nv">file: </span><span class="nf">(proto, path, work, cb) -&gt;</span>
    <span class="nv">fs = </span><span class="nx">require</span> <span class="s">&#39;alinex-fs&#39;</span>
    <span class="nv">fspath = </span><span class="nx">require</span> <span class="s">&#39;path&#39;</span>
    <span class="nv">path = </span><span class="nx">fspath</span><span class="p">.</span><span class="nx">resolve</span> <span class="nx">work</span><span class="p">.</span><span class="nx">spec</span><span class="p">.</span><span class="nx">dir</span><span class="p">,</span> <span class="nx">path</span> <span class="k">if</span> <span class="nx">work</span><span class="p">.</span><span class="nx">spec</span><span class="o">?</span><span class="p">.</span><span class="nx">dir</span><span class="o">?</span>
    <span class="nx">fs</span><span class="p">.</span><span class="nx">realpath</span> <span class="nx">path</span><span class="p">,</span> <span class="nf">(err, path) -&gt;</span>
      <span class="k">return</span> <span class="nx">cb</span> <span class="nx">err</span> <span class="k">if</span> <span class="nx">err</span>
      <span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span> <span class="nx">path</span><span class="p">,</span> <span class="s">&#39;utf-8&#39;</span><span class="p">,</span> <span class="nx">cb</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="read%20from%20web%20resource">
  <h4>
    <a href="#read%20from%20web%20resource" name="read%20from%20web%20resource" class="pilcrow">&#182;</a>
    Read from web resource
  </h4>
</div>

        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="nv">web: </span><span class="nf">(proto, path, work, cb) -&gt;</span>
    <span class="nv">request = </span><span class="nx">require</span> <span class="s">&#39;request&#39;</span>
    <span class="nx">request</span>
      <span class="nv">uri: </span><span class="s">&quot;</span><span class="si">#{</span><span class="nx">proto</span><span class="si">}</span><span class="s">://</span><span class="si">#{</span><span class="nx">path</span><span class="si">}</span><span class="s">&quot;</span>
      <span class="nv">followAllRedirects: </span><span class="kc">true</span>
    <span class="p">,</span> <span class="nf">(err, response, body) -&gt;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-57" id="section-57">&#182;</a>
</div>
<p>error checking</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="k">return</span> <span class="nx">cb</span> <span class="nx">err</span> <span class="k">if</span> <span class="nx">err</span>
      <span class="k">if</span> <span class="nx">response</span><span class="p">.</span><span class="nx">statusCode</span> <span class="o">isnt</span> <span class="mi">200</span>
        <span class="k">return</span> <span class="nx">cb</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s">&quot;Server send wrong return code: </span><span class="si">#{</span><span class="nx">response</span><span class="p">.</span><span class="nx">statusCode</span><span class="si">}</span><span class="s">&quot;</span>
      <span class="k">return</span> <span class="nx">cb</span><span class="p">()</span> <span class="k">unless</span> <span class="nx">body</span><span class="o">?</span>
      <span class="nx">cb</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">body</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="read%20from%20command%20output">
  <h4>
    <a href="#read%20from%20command%20output" name="read%20from%20command%20output" class="pilcrow">&#182;</a>
    Read from command output
  </h4>
</div>

        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="nv">cmd: </span><span class="nf">(proto, path, work, cb) -&gt;</span>
    <span class="nv">exec = </span><span class="nx">require</span><span class="p">(</span><span class="s">&#39;child_process&#39;</span><span class="p">).</span><span class="nx">exec</span>
    <span class="nv">opt = </span><span class="p">{}</span>
    <span class="nv">opt.cwd = </span><span class="nx">work</span><span class="p">.</span><span class="nx">spec</span><span class="p">.</span><span class="nx">dir</span> <span class="k">if</span> <span class="nx">work</span><span class="p">.</span><span class="nx">spec</span><span class="o">?</span><span class="p">.</span><span class="nx">dir</span><span class="o">?</span>
    <span class="nx">exec</span> <span class="nx">path</span><span class="p">,</span> <span class="nx">opt</span><span class="p">,</span> <span class="nx">cb</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="read%20from%20value%20structure">
  <h3>
    <a href="#read%20from%20value%20structure" name="read%20from%20value%20structure" class="pilcrow">&#182;</a>
    Read from value structure
  </h3>
</div>

        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nv">findData = </span><span class="nf">(path, work, cb) -&gt;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-60" id="section-60">&#182;</a>
</div>
<p>split path</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="nv">path = </span><span class="nx">path</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="s">&#39;/\/+$/&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">).</span><span class="nx">split</span> <span class="sr">/\/+/</span> <span class="k">if</span> <span class="k">typeof</span> <span class="nx">path</span> <span class="o">is</span> <span class="s">&#39;string&#39;</span>
  <span class="nx">work</span><span class="p">.</span><span class="nx">path</span> <span class="o">?=</span> <span class="p">[]</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-61" id="section-61">&#182;</a>
</div>
<p>find first level</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="nv">first = </span><span class="nx">path</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-62" id="section-62">&#182;</a>
</div>
<p>absolute path, go on</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="k">return</span> <span class="nx">cb</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">object</span><span class="p">.</span><span class="nx">pathSearch</span> <span class="nx">work</span><span class="p">.</span><span class="nx">data</span><span class="p">,</span> <span class="nx">path</span><span class="p">[</span><span class="mi">1</span><span class="p">..]</span> <span class="k">if</span> <span class="nx">first</span> <span class="o">is</span> <span class="s">&#39;&#39;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-63" id="section-63">&#182;</a>
</div>
<p>search at current position</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="nv">skip = </span><span class="mi">0</span>
  <span class="nx">skip</span><span class="o">++</span> <span class="k">while</span> <span class="nx">path</span><span class="p">[</span><span class="nx">skip</span><span class="p">]</span> <span class="o">is</span> <span class="s">&#39;..&#39;</span>
  <span class="nv">result = </span><span class="nx">object</span><span class="p">.</span><span class="nx">pathSearch</span> <span class="nx">work</span><span class="p">.</span><span class="nx">data</span><span class="p">,</span> <span class="nx">work</span><span class="p">.</span><span class="nx">path</span><span class="p">[</span><span class="mi">0</span><span class="p">..</span><span class="nx">work</span><span class="p">.</span><span class="nx">path</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="nx">skip</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="nx">concat</span> <span class="nx">path</span><span class="p">[</span><span class="nx">skip</span><span class="p">..]</span>
  <span class="k">if</span> <span class="nx">result</span> <span class="o">and</span> <span class="nx">work</span><span class="p">.</span><span class="nx">spec</span><span class="o">?</span><span class="p">.</span><span class="nx">done</span><span class="o">?</span>
    <span class="nv">checkpath = </span><span class="nx">work</span><span class="p">.</span><span class="nx">path</span><span class="p">[</span><span class="mi">0</span><span class="p">..</span><span class="nx">work</span><span class="p">.</span><span class="nx">path</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="nx">skip</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="nx">concat</span><span class="p">(</span><span class="nx">path</span><span class="p">[</span><span class="nx">skip</span><span class="p">..]).</span><span class="nx">join</span> <span class="s">&#39;/&#39;</span>
    <span class="k">unless</span> <span class="nx">checkpath</span> <span class="k">in</span> <span class="nx">work</span><span class="p">.</span><span class="nx">spec</span><span class="p">.</span><span class="nx">done</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-64" id="section-64">&#182;</a>
</div>
<p>check for retry</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="nx">work</span><span class="p">.</span><span class="nx">retry</span> <span class="o">?=</span> <span class="mi">0</span>
      <span class="k">if</span> <span class="nx">work</span><span class="p">.</span><span class="nx">retry</span> <span class="o">&gt;</span> <span class="nx">MAXRETRY</span><span class="o">/</span><span class="nx">TIMEOUT</span>
        <span class="nv">work.spec.failed = </span><span class="kc">true</span>
        <span class="k">return</span> <span class="k">throw</span> <span class="nb">Error</span> <span class="s">&quot;Stopped because of uncheckable </span><span class="si">#{</span><span class="nx">work</span><span class="p">.</span><span class="nx">spec</span><span class="p">.</span><span class="nx">name</span><span class="si">}</span><span class="s">/</span><span class="si">#{</span><span class="nx">checkpath</span><span class="si">}</span><span class="s">&quot;</span>
      <span class="k">return</span> <span class="nx">setTimeout</span> <span class="nf">-&gt;</span>
        <span class="k">return</span> <span class="k">if</span> <span class="nx">work</span><span class="p">.</span><span class="nx">spec</span><span class="p">.</span><span class="nx">failed</span> <span class="c1"># processing already stopped</span>
        <span class="nx">work</span><span class="p">.</span><span class="nx">retry</span><span class="o">++</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-65" id="section-65">&#182;</a>
</div>
<p>reread value from spec</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nv">work.data = </span><span class="nx">work</span><span class="p">.</span><span class="nx">spec</span><span class="p">.</span><span class="nx">value</span>
        <span class="nx">findData</span> <span class="nx">path</span><span class="p">,</span> <span class="nx">work</span><span class="p">,</span> <span class="nx">cb</span>
      <span class="p">,</span> <span class="nx">TIMEOUT</span>
  <span class="k">return</span> <span class="nx">cb</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">result</span> <span class="k">if</span> <span class="nx">result</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-66" id="section-66">&#182;</a>
</div>
<p>check if not at the end</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="k">return</span> <span class="nx">cb</span><span class="p">()</span> <span class="k">unless</span> <span class="nx">work</span><span class="p">.</span><span class="nx">path</span><span class="p">.</span><span class="nx">length</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-67" id="section-67">&#182;</a>
</div>
<p>search neighbors by sub call on parent</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="nv">sub = </span><span class="nx">object</span><span class="p">.</span><span class="nx">clone</span> <span class="nx">work</span>
  <span class="nv">sub.spec = </span><span class="nx">work</span><span class="p">.</span><span class="nx">spec</span>
  <span class="nx">sub</span><span class="p">.</span><span class="nx">path</span><span class="p">.</span><span class="nx">pop</span><span class="p">()</span>
  <span class="nx">findData</span> <span class="nx">path</span><span class="p">,</span> <span class="nx">sub</span><span class="p">,</span> <span class="nx">cb</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="recursively%20join%20array%20of%20arrays%20together">
  <h3>
    <a href="#recursively%20join%20array%20of%20arrays%20together" name="recursively%20join%20array%20of%20arrays%20together" class="pilcrow">&#182;</a>
    Recursively join array of arrays together
  </h3>
</div>

        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nv">arrayJoin = </span><span class="nf">(data, splitter) -&gt;</span>
  <span class="nv">glue = </span><span class="k">if</span> <span class="nx">splitter</span><span class="p">.</span><span class="nx">length</span> <span class="o">is</span> <span class="mi">1</span> <span class="k">then</span> <span class="nx">splitter</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">else</span> <span class="nx">splitter</span><span class="p">.</span><span class="nx">shift</span><span class="p">()</span>
  <span class="nv">result = </span><span class="s">&#39;&#39;</span>
  <span class="k">for</span> <span class="nx">v</span> <span class="k">in</span> <span class="nx">data</span>
    <span class="nv">v = </span><span class="nx">arrayJoin</span> <span class="nx">v</span><span class="p">,</span> <span class="nx">splitter</span> <span class="k">if</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span> <span class="nx">v</span>
    <span class="nx">result</span> <span class="o">+=</span> <span class="nx">glue</span> <span class="k">if</span> <span class="nx">result</span>
    <span class="nx">result</span> <span class="o">+=</span> <span class="nx">v</span>
  <span class="nx">result</span>
</pre></div>
        </td>
      </tr>
  </tbody>
</table>
  </div>
</body>
</html>
