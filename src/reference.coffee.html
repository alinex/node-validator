<!DOCTYPE html>
<html>
<head>
  <title>reference.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../doc-style.css" />
  <script src="../doc-filelist.js"></script>
  <script>
    var relativeDir = "../";
    var thisFile = "home/alex/github/node-validator/src/reference.coffee";
    var defaultSidebar = true;
  </script>
  <script src="../doc-script.js"></script>

<meta name="viewport" content="width=device-width, initial-scale=1.0" /></head
<body>
  <nav>
<div class="logo"><a href="http://alinex.github.io"
  onmouseover="logo.src='https://alinex.github.io/images/Alinex-200.png'"
  onmouseout="logo.src='https://alinex.github.io/images/Alinex-black-200.png'">
  <img name="logo" src="https://alinex.github.io/images/Alinex-black-200.png"
    width="150" title="Alinex Universe Homepage" />
  </a>
  <img src="http://alinex.github.io/images/Alinex-200.png"
    style="display:none" alt="preloading" />
</div>
<div class="links">
  <a href="http://alinex.github.io/blog"
    class="btn btn-primary"><span class="glyphicon-pencil"></span> Blog</a>
  <a href="http://alinex.github.io/develop"
    class="btn btn-primary"><span class="glyphicon-book"></span> Develop</a>
  <a href="http://alinex.github.io/code.html"
    class="btn btn-warning"><span class="glyphicon-cog"></span> Code</a>
</div>
</nav><div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

      <div class="heading h1">
        <a href="#ip-address-validation">IP Address validation</a>
      </div>

      <div class="heading h2">
        <a href="#node-modules">Node modules</a>
      </div>

      <div class="heading h2">
        <a href="#configuration">Configuration</a>
      </div>

      <div class="heading h2">
        <a href="#have-references">Have references</a>
      </div>

      <div class="heading h2">
        <a href="#replace-references">Replace references</a>
      </div>

      <div class="heading h2">
        <a href="#helper-methods">Helper methods</a>
      </div>

      <div class="heading h3">
        <a href="#search-through-alternative-sources">search through alternative sources</a>
      </div>

      <div class="heading h3">
        <a href="#find-reference">Find reference</a>
      </div>

      <div class="heading h3">
        <a href="#find-value-of-specific-type">Find value of specific type</a>
      </div>

      <div class="heading h4">
        <a href="#value-checks">Value checks</a>
      </div>

      <div class="heading h4">
        <a href="#splitting-of-strings">Splitting of strings</a>
      </div>

      <div class="heading h4">
        <a href="#matching-strings">Matching strings</a>
      </div>

      <div class="heading h4">
        <a href="#special-parsing-of-string">Special parsing of string</a>
      </div>

      <div class="heading h4">
        <a href="#range-selection-in-array">Range selection in array</a>
      </div>

      <div class="heading h4">
        <a href="#path-selection-in-object">Path selection in object</a>
      </div>

      <div class="heading h4">
        <a href="#join-array-together">Join array together</a>
      </div>

      <div class="heading h4">
        <a href="#accessing-environment-variable">Accessing environment variable</a>
      </div>

      <div class="heading h4">
        <a href="#read-from-value-structure">Read from value structure</a>
      </div>

      <div class="heading h4">
        <a href="#read-from-additional-context">Read from additional context</a>
      </div>

      <div class="heading h4">
        <a href="#read-from-file">Read from file</a>
      </div>

      <div class="heading h4">
        <a href="#read-from-web-resource">Read from web resource</a>
      </div>

      <div class="heading h4">
        <a href="#read-from-command-output">Read from command output</a>
      </div>

      <div class="heading h3">
        <a href="#read-from-value-structure-1">Read from value structure</a>
      </div>

      <div class="heading h3">
        <a href="#recursively-join-array-of-arrays-together">Recursively join array of arrays together</a>
      </div>

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container" tabindex="0"><a id="fork" href="https://github.com/alinex/node-validator" title="Fork me on GitHub"></a>
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="ip-address-validation">
  <h1>
    <a href="#ip-address-validation" name="ip-address-validation" class="pilcrow"></a>
IP Address validation
  </h1>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2"></a>
</div>
<p>The following properties are used:</p>
<ul>
<li>spec - reference to the original validation call
<ul>
<li>name - (string) descriptive name of the data</li>
<li>schema - (object) structure to check</li>
<li>context - (object) additional data structure</li>
<li>dir - set to base directory for file relative file paths</li>
</ul>
</li>
<li>path - array containing the current path</li>
<li>pos - reference to schema position at this path</li>
<li>debug - output of current path for debugging</li>
<li>value - value at this path</li>
</ul>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3"></a>
</div>
<p>While working on the data the following values will be added:</p>
<ul>
<li>data - structure to work on (schema or context)</li>
<li>lastType - the type of the last checked reference to ensure security</li>
</ul>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="node-modules">
  <h2>
    <a href="#node-modules" name="node-modules" class="pilcrow"></a>
Node modules
  </h2>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">debug = <span class="hljs-built_in">require</span>(<span class="hljs-string">'debug'</span>)(<span class="hljs-string">'validator:reference'</span>)
util = <span class="hljs-built_in">require</span> <span class="hljs-string">'util'</span>
chalk = <span class="hljs-built_in">require</span> <span class="hljs-string">'chalk'</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5"></a>
</div>
<p>alinex modules</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">async = <span class="hljs-built_in">require</span> <span class="hljs-string">'alinex-async'</span>
{object} = <span class="hljs-built_in">require</span> <span class="hljs-string">'alinex-util'</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-6" id="section-6"></a>
</div>
<p>include classes and helper</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">check = <span class="hljs-built_in">require</span> <span class="hljs-string">'./check'</span>

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="configuration">
  <h2>
    <a href="#configuration" name="configuration" class="pilcrow"></a>
Configuration
  </h2>
</div>
<p>MAXRETRY defines the time to wait till the references should be solved</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">MAXRETRY = <span class="hljs-number">10000</span> <span class="hljs-comment"># waiting for 10 seconds at max</span>
TIMEOUT = <span class="hljs-number">10</span> <span class="hljs-comment"># checking every 10ms</span>

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-8" id="section-8"></a>
</div>
<p>defines specific type handler for some protocols</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">protocolMap =
  <span class="hljs-attribute">http</span>: <span class="hljs-string">'web'</span>
  <span class="hljs-attribute">https</span>: <span class="hljs-string">'web'</span>

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-9" id="section-9"></a>
</div>
<p>to ensure security a reference can only call references with lower precedence</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">typePrecedence =
  <span class="hljs-attribute">env</span>: <span class="hljs-number">5</span>
  <span class="hljs-attribute">struct</span>: <span class="hljs-number">4</span>
  <span class="hljs-attribute">context</span>: <span class="hljs-number">3</span>
  <span class="hljs-attribute">file</span>: <span class="hljs-number">2</span>
  <span class="hljs-attribute">cmd</span>: <span class="hljs-number">2</span>
  <span class="hljs-attribute">web</span>: <span class="hljs-number">1</span>

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="have-references">
  <h2>
    <a href="#have-references" name="have-references" class="pilcrow"></a>
Have references
  </h2>
</div>
<p>Check if there are references in the object.</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">exists = exports.exists = <span class="hljs-function"><span class="hljs-params">(value)</span> -&gt;</span>
  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span> <span class="hljs-keyword">unless</span> <span class="hljs-keyword">typeof</span> value <span class="hljs-keyword">is</span> <span class="hljs-string">'string'</span>
  Boolean value.match <span class="hljs-regexp">/&lt;&lt;&lt;[^]*&gt;&gt;&gt;/</span>

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="replace-references">
  <h2>
    <a href="#replace-references" name="replace-references" class="pilcrow"></a>
Replace references
  </h2>
</div>
<p>This is called from the check to resolve the references first before running
the real check. If there are no references it will return immediately.</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">exports.replace = <span class="hljs-function"><span class="hljs-params">(value, work={}, cb)</span> -&gt;</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-12" id="section-12"></a>
</div>
<p>maybe called without work (mostly for)</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> work <span class="hljs-keyword">is</span> <span class="hljs-string">'function'</span>
    cb = work
    work = {}
  <span class="hljs-keyword">return</span> cb <span class="hljs-literal">null</span>, value <span class="hljs-keyword">unless</span> exists value
  work.data ?= work.spec?.value
  debug <span class="hljs-string">"replace <span class="hljs-subst">#{util.inspect value}</span>..."</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-13" id="section-13"></a>
</div>
<p>step over parts</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  refs = value.split <span class="hljs-regexp">/(&lt;&lt;&lt;[^]*?&gt;&gt;&gt;)/</span>
  refs = [refs[<span class="hljs-number">1</span>]] <span class="hljs-keyword">if</span> refs.length <span class="hljs-keyword">is</span> <span class="hljs-number">3</span> <span class="hljs-keyword">and</span> refs[<span class="hljs-number">0</span>] <span class="hljs-keyword">is</span> <span class="hljs-string">''</span> <span class="hljs-keyword">and</span> refs[<span class="hljs-number">2</span>] <span class="hljs-keyword">is</span> <span class="hljs-string">''</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-14" id="section-14"></a>
</div>
<p>check all references</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  async.map refs, <span class="hljs-function"><span class="hljs-params">(v, cb)</span> -&gt;</span>
    findAlternative v, work, cb
  , <span class="hljs-function"><span class="hljs-params">(err, results)</span> -&gt;</span>
    <span class="hljs-keyword">return</span> cb() <span class="hljs-keyword">if</span> err
    <span class="hljs-keyword">if</span> results.length <span class="hljs-keyword">is</span> <span class="hljs-number">1</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-15" id="section-15"></a>
</div>
<p>return first result if only one reference used</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">      debug <span class="hljs-string">"<span class="hljs-subst">#{util.inspect value}</span> is replaced by <span class="hljs-subst">#{util.inspect results[<span class="hljs-number">0</span>]}</span>"</span>
      <span class="hljs-keyword">return</span> cb <span class="hljs-literal">null</span>, results[<span class="hljs-number">0</span>]
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-16" id="section-16"></a>
</div>
<p>combine reference together</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    result = results.join <span class="hljs-string">''</span>
    debug <span class="hljs-string">"<span class="hljs-subst">#{util.inspect value}</span> is replaced by <span class="hljs-subst">#{util.inspect result}</span>"</span>
    cb <span class="hljs-literal">null</span>, result

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="helper-methods">
  <h2>
    <a href="#helper-methods" name="helper-methods" class="pilcrow"></a>
Helper methods
  </h2>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="search-through-alternative-sources">
  <h3>
    <a href="#search-through-alternative-sources" name="search-through-alternative-sources" class="pilcrow"></a>
search through alternative sources
  </h3>
</div>
<p>Alternative sources are separated by <code>|</code> and the first possible alternative
should be used.</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript"><span class="hljs-function"><span class="hljs-title">findAlternative</span> = <span class="hljs-params">(value, work={}, cb)</span> -&gt;</span>
  <span class="hljs-keyword">return</span> cb <span class="hljs-literal">null</span>, value <span class="hljs-keyword">unless</span> ~value.indexOf <span class="hljs-string">'&lt;&lt;&lt;'</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-19" id="section-19"></a>
</div>
<p>replace &lt;&lt;&lt; and &gt;&gt;&gt; and split into alternatives</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  first = <span class="hljs-literal">true</span>
  async.map value[<span class="hljs-number">3.</span>.-<span class="hljs-number">4</span>].split(<span class="hljs-regexp">/\s+\|\s+/</span>), <span class="hljs-function"><span class="hljs-params">(alt, cb)</span> -&gt;</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-20" id="section-20"></a>
</div>
<p>automatically set first element to <code>struct</code> if no other protocol set</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    <span class="hljs-keyword">if</span> first <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> ~alt.indexOf <span class="hljs-string">'://'</span>
      alt = <span class="hljs-string">"struct://<span class="hljs-subst">#{alt}</span>"</span>
    first = <span class="hljs-literal">false</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-21" id="section-21"></a>
</div>
<p>split uri into anchored separated paths</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    alt = alt[<span class="hljs-number">0.</span>.alt.length-<span class="hljs-number">2</span>] <span class="hljs-keyword">while</span> alt[alt.length-<span class="hljs-number">1</span>] <span class="hljs-keyword">is</span> <span class="hljs-string">'#'</span>
    uriPart = alt.split <span class="hljs-regexp">/#/</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-22" id="section-22"></a>
</div>
<p>return default value</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    <span class="hljs-keyword">if</span> uriPart.length <span class="hljs-keyword">is</span> <span class="hljs-number">1</span> <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> ~alt.indexOf <span class="hljs-string">'://'</span>
      debug chalk.grey <span class="hljs-string">"<span class="hljs-subst">#{util.inspect alt}</span> -&gt; default value: <span class="hljs-subst">#{util.inspect alt}</span>"</span>
      <span class="hljs-keyword">return</span> cb <span class="hljs-literal">null</span>, alt
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-23" id="section-23"></a>
</div>
<p>read value from given uri parts</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    find uriPart, work, <span class="hljs-function"><span class="hljs-params">(err, result)</span> -&gt;</span>
      <span class="hljs-keyword">if</span> err
        debug chalk.grey <span class="hljs-string">"<span class="hljs-subst">#{util.inspect alt}</span> -&gt; failed: <span class="hljs-subst">#{err.message}</span>"</span>
        <span class="hljs-keyword">return</span> cb err
      debug chalk.grey <span class="hljs-string">"<span class="hljs-subst">#{util.inspect alt}</span> -&gt; result: <span class="hljs-subst">#{util.inspect result}</span>"</span>
      cb <span class="hljs-literal">null</span>, result
  , <span class="hljs-function"><span class="hljs-params">(err, results)</span> -&gt;</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-24" id="section-24"></a>
</div>
<p>find first alternative</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    <span class="hljs-keyword">for</span> result <span class="hljs-keyword">in</span> results
      <span class="hljs-keyword">return</span> cb <span class="hljs-literal">null</span>, result <span class="hljs-keyword">if</span> result?
    cb()

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="find-reference">
  <h3>
    <a href="#find-reference" name="find-reference" class="pilcrow"></a>
Find reference
  </h3>
</div>
<p>This method is called with all the uri parts as list and will search the
value of the first uri part, pass it on to the second search as data and so
on. The result will be from the last uri path.</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript"><span class="hljs-function"><span class="hljs-title">find</span> = <span class="hljs-params">(list, work={}, cb)</span> -&gt;</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-26" id="section-26"></a>
</div>
<p>get type of uri part</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  def = list.shift()
  <span class="hljs-keyword">return</span> cb <span class="hljs-literal">null</span>, work.data <span class="hljs-keyword">unless</span> def <span class="hljs-comment"># empty anchor</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-27" id="section-27"></a>
</div>
<p>detect protocol</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  [proto, path] = def.split <span class="hljs-regexp">/:\/\//</span>
  path ?= proto
  proto = <span class="hljs-keyword">switch</span> proto[<span class="hljs-number">0</span>]
    <span class="hljs-keyword">when</span> <span class="hljs-string">'{'</span> <span class="hljs-keyword">then</span> <span class="hljs-string">'check'</span>
    <span class="hljs-keyword">when</span> <span class="hljs-string">'%'</span> <span class="hljs-keyword">then</span> <span class="hljs-string">'split'</span>
    <span class="hljs-keyword">when</span> <span class="hljs-string">'/'</span> <span class="hljs-keyword">then</span> <span class="hljs-string">'match'</span>
    <span class="hljs-keyword">when</span> <span class="hljs-string">'$'</span> <span class="hljs-keyword">then</span> <span class="hljs-string">'parse'</span>
    <span class="hljs-keyword">else</span>
      <span class="hljs-keyword">if</span> def.match <span class="hljs-regexp">/^\d/</span> <span class="hljs-keyword">then</span> <span class="hljs-string">'range'</span>
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">unless</span> ~def.indexOf <span class="hljs-string">'://'</span>  <span class="hljs-keyword">then</span> <span class="hljs-string">'object'</span>
      <span class="hljs-keyword">else</span> proto
  <span class="hljs-keyword">if</span> proto <span class="hljs-keyword">is</span> <span class="hljs-string">'parse'</span> <span class="hljs-keyword">and</span> ~path.indexOf <span class="hljs-string">'$join'</span>
    proto = <span class="hljs-string">'join'</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-28" id="section-28"></a>
</div>
<p>return if not possible without data (incorrect use)</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  <span class="hljs-keyword">return</span> cb() <span class="hljs-keyword">if</span> def[<span class="hljs-number">0.</span>.proto.length-<span class="hljs-number">1</span>] <span class="hljs-keyword">isnt</span> proto <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> work.data?
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-29" id="section-29"></a>
</div>
<p>run automatic conversion of data if needed</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  <span class="hljs-keyword">switch</span>
    <span class="hljs-keyword">when</span> <span class="hljs-keyword">typeof</span> work.data <span class="hljs-keyword">is</span> <span class="hljs-string">'string'</span>
      <span class="hljs-keyword">switch</span> proto
        <span class="hljs-keyword">when</span> <span class="hljs-string">'range'</span>
          list.unshift def
          proto = <span class="hljs-string">'split'</span>
          path = <span class="hljs-string">'%\n'</span>
        <span class="hljs-keyword">when</span> <span class="hljs-string">'object'</span>
          list.unshift def
          proto = <span class="hljs-string">'parse'</span>
          path = <span class="hljs-string">'$auto'</span>
    <span class="hljs-keyword">when</span> Array.isArray work.data
      <span class="hljs-keyword">switch</span> proto
        <span class="hljs-keyword">when</span> <span class="hljs-string">'object'</span>, <span class="hljs-string">'split'</span>, <span class="hljs-string">'match'</span>
          list.unshift def
          proto = <span class="hljs-string">'join'</span>
          path = <span class="hljs-string">'$join'</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-30" id="section-30"></a>
</div>
<p>check for impossible result data</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  <span class="hljs-keyword">if</span> (
    (<span class="hljs-keyword">not</span> Array.isArray(work.data) <span class="hljs-keyword">and</span> proto <span class="hljs-keyword">in</span> [<span class="hljs-string">'range'</span>, <span class="hljs-string">'join'</span>]) <span class="hljs-keyword">or</span>
    (<span class="hljs-keyword">typeof</span> work.data <span class="hljs-keyword">isnt</span> <span class="hljs-string">'string'</span> <span class="hljs-keyword">and</span> proto <span class="hljs-keyword">in</span> [<span class="hljs-string">'split'</span>, <span class="hljs-string">'match'</span>, <span class="hljs-string">'parse'</span>]) <span class="hljs-keyword">or</span>
    (<span class="hljs-keyword">typeof</span> work.data <span class="hljs-keyword">isnt</span> <span class="hljs-string">'object'</span> <span class="hljs-keyword">and</span> proto <span class="hljs-keyword">is</span> <span class="hljs-string">'object'</span>)
    )
      debug chalk.grey <span class="hljs-string">"stop at part <span class="hljs-subst">#{proto}</span>://<span class="hljs-subst">#{path}</span> because wrong result type"</span>
      <span class="hljs-keyword">return</span> cb()
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-31" id="section-31"></a>
</div>
<p>find type handler</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  proto = proto.toLowerCase()
  type = protocolMap[proto] ? proto
  debug chalk.grey <span class="hljs-string">"check part "</span> + util.inspect <span class="hljs-string">"<span class="hljs-subst">#{proto}</span>://<span class="hljs-subst">#{path}</span>"</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-32" id="section-32"></a>
</div>
<p>check for correct handler</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  <span class="hljs-keyword">unless</span> findType[type]?
    <span class="hljs-keyword">return</span> cb <span class="hljs-keyword">new</span> Error <span class="hljs-string">"No handler for protocol <span class="hljs-subst">#{proto}</span> for references defined"</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-33" id="section-33"></a>
</div>
<p>check precedence for next uri</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  <span class="hljs-keyword">if</span> work.lastType? <span class="hljs-keyword">and</span> typePrecedence[type] &gt; typePrecedence[work.lastType?]
    <span class="hljs-keyword">return</span> cb <span class="hljs-keyword">new</span> Error <span class="hljs-string">"<span class="hljs-subst">#{type}</span>-reference can not be called from <span class="hljs-subst">#{proto}</span>-reference
    for security reasons"</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-34" id="section-34"></a>
</div>
<p>run type handler and return if nothing found</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  work.lastType = type
  findType[type] proto, path, work, <span class="hljs-function"><span class="hljs-params">(err, result)</span> -&gt;</span>
    <span class="hljs-keyword">return</span> cb err <span class="hljs-keyword">if</span> err
    <span class="hljs-keyword">unless</span> result <span class="hljs-comment"># no result so stop this uri</span>
      <span class="hljs-keyword">if</span> list.length
        debug chalk.grey util.inspect(<span class="hljs-string">"<span class="hljs-subst">#{proto}</span>://<span class="hljs-subst">#{path}</span>"</span>) + <span class="hljs-string">" -&gt; result: ---"</span>
      <span class="hljs-keyword">return</span> cb()
    <span class="hljs-keyword">if</span> list.length
      debug chalk.grey util.inspect(<span class="hljs-string">"<span class="hljs-subst">#{proto}</span>://<span class="hljs-subst">#{path}</span>"</span>) + <span class="hljs-string">" -&gt; result: <span class="hljs-subst">#{util.inspect result}</span>"</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-35" id="section-35"></a>
</div>
<p>no reference in result</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    <span class="hljs-keyword">unless</span> exists result
      <span class="hljs-keyword">return</span> cb <span class="hljs-literal">null</span>, result <span class="hljs-keyword">unless</span> list.length <span class="hljs-comment"># stop if last entry of uri path</span>
      work = object.extend {}, work
      work.data = result
      <span class="hljs-keyword">return</span> find list, work, cb
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-36" id="section-36"></a>
</div>
<p>check for retry</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    work.retry ?= <span class="hljs-number">0</span>
    <span class="hljs-keyword">if</span> work.retry &gt; MAXRETRY/TIMEOUT
      work.spec.failed = <span class="hljs-literal">true</span>
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">throw</span> Error <span class="hljs-string">"Stopped because of circular references at
</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-37" id="section-37"></a>
</div>
<p>{work.spec.name}/#{work.path.join '/'}&quot;
retry the same call again</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    list.unshift def
    setTimeout -&gt;
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> work.spec.failed <span class="hljs-comment"># processing already stopped</span>
      work.retry++
      find list, work, cb
    , TIMEOUT

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="find-value-of-specific-type">
  <h3>
    <a href="#find-value-of-specific-type" name="find-value-of-specific-type" class="pilcrow"></a>
Find value of specific type
  </h3>
</div>
<p>This is a collection of methods for specific protocols.</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">findType =
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="value-checks">
  <h4>
    <a href="#value-checks" name="value-checks" class="pilcrow"></a>
Value checks
  </h4>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  <span class="hljs-attribute">check</span>: <span class="hljs-function"><span class="hljs-params">(proto, path, work, cb)</span> -&gt;</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-40" id="section-40"></a>
</div>
<p>get the check schema reading as js</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    vm = <span class="hljs-built_in">require</span> <span class="hljs-string">'vm'</span>
    schema = vm.runInNewContext <span class="hljs-string">"x=<span class="hljs-subst">#{path}</span>"</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-41" id="section-41"></a>
</div>
<p>run the subcheck</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    name = work.spec?.name ? <span class="hljs-string">'value'</span>
    check.run
      <span class="hljs-attribute">name</span>: name + <span class="hljs-string">'#ref'</span>
      <span class="hljs-attribute">schema</span>: schema
      <span class="hljs-attribute">value</span>: work.data
    , <span class="hljs-function"><span class="hljs-params">(err, value)</span> -&gt;</span>
      <span class="hljs-keyword">if</span> err
        debug chalk.grey <span class="hljs-string">"'<span class="hljs-subst">#{proto}</span>://<span class="hljs-subst">#{path}</span>' -&gt; check failed: <span class="hljs-subst">#{err.message}</span>"</span>
        <span class="hljs-keyword">return</span> cb()
      cb <span class="hljs-literal">null</span>, value
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="splitting-of-strings">
  <h4>
    <a href="#splitting-of-strings" name="splitting-of-strings" class="pilcrow"></a>
Splitting of strings
  </h4>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  <span class="hljs-attribute">split</span>: <span class="hljs-function"><span class="hljs-params">(proto, path, work, cb)</span> -&gt;</span>
    path = path[<span class="hljs-number">1.</span>.]
    splitter = path.split(<span class="hljs-string">'//'</span>).map (s) -&gt; <span class="hljs-keyword">new</span> RegExp s
    splitter.push <span class="hljs-string">''</span> <span class="hljs-keyword">if</span> splitter.length <span class="hljs-keyword">is</span> <span class="hljs-number">1</span>
    result = work.data.split(splitter[<span class="hljs-number">0</span>]).map (t) -&gt;
      col = t.split splitter[<span class="hljs-number">1</span>]
      col.unshift t
      col
    result.unshift <span class="hljs-literal">null</span>
    cb <span class="hljs-literal">null</span>, result
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="matching-strings">
  <h4>
    <a href="#matching-strings" name="matching-strings" class="pilcrow"></a>
Matching strings
  </h4>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  <span class="hljs-attribute">match</span>: <span class="hljs-function"><span class="hljs-params">(proto, path, work, cb)</span> -&gt;</span>
    re = path.match <span class="hljs-regexp">/\/([^]*)\/(i?)/</span>
    re = <span class="hljs-keyword">new</span> RegExp re[<span class="hljs-number">1</span>], <span class="hljs-string">"<span class="hljs-subst">#{re[<span class="hljs-number">2</span>]}</span>g"</span>
    cb <span class="hljs-literal">null</span>, work.data.match re
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="special-parsing-of-string">
  <h4>
    <a href="#special-parsing-of-string" name="special-parsing-of-string" class="pilcrow"></a>
Special parsing of string
  </h4>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  <span class="hljs-attribute">parse</span>: <span class="hljs-function"><span class="hljs-params">(proto, path, work, cb)</span> -&gt;</span>
    <span class="hljs-keyword">switch</span> path
      <span class="hljs-keyword">when</span> <span class="hljs-string">'$js'</span>
        vm = <span class="hljs-built_in">require</span> <span class="hljs-string">'vm'</span>
        cb <span class="hljs-literal">null</span>, vm.runInNewContext <span class="hljs-string">"x=<span class="hljs-subst">#{work.data}</span>"</span>
      <span class="hljs-keyword">when</span> <span class="hljs-string">'$json'</span>
        <span class="hljs-keyword">try</span>
          result = JSON.parse work.data
        <span class="hljs-keyword">catch</span> error
          debug chalk.grey <span class="hljs-string">"'<span class="hljs-subst">#{proto}</span>://<span class="hljs-subst">#{path}</span>' -&gt; check failed: <span class="hljs-subst">#{error.message}</span>"</span>
          <span class="hljs-keyword">return</span> cb()
        cb <span class="hljs-literal">null</span>, result
      <span class="hljs-keyword">when</span> <span class="hljs-string">'$yaml'</span>
        yaml = <span class="hljs-built_in">require</span> <span class="hljs-string">'js-yaml'</span>
        <span class="hljs-keyword">try</span>
          result = yaml.safeLoad work.data
        <span class="hljs-keyword">catch</span> error
          debug chalk.grey <span class="hljs-string">"'<span class="hljs-subst">#{proto}</span>://<span class="hljs-subst">#{path}</span>' -&gt; check failed: <span class="hljs-subst">#{error.message}</span>"</span>
          <span class="hljs-keyword">return</span> cb()
        cb <span class="hljs-literal">null</span>, result
      <span class="hljs-keyword">when</span> <span class="hljs-string">'$xml'</span>
        xml2js = <span class="hljs-built_in">require</span> <span class="hljs-string">'xml2js'</span>
        xml2js.parseString work.data, <span class="hljs-function"><span class="hljs-params">(err, result)</span> -&gt;</span>
          <span class="hljs-keyword">if</span> err
            debug chalk.grey <span class="hljs-string">"'<span class="hljs-subst">#{proto}</span>://<span class="hljs-subst">#{path}</span>' -&gt; check failed: <span class="hljs-subst">#{err.message}</span>"</span>
            <span class="hljs-keyword">return</span> cb()
          cb <span class="hljs-literal">null</span>, result
      <span class="hljs-keyword">when</span> <span class="hljs-string">'$auto'</span>
        result = <span class="hljs-literal">null</span>
        async.detectSeries [<span class="hljs-string">'$yaml'</span>, <span class="hljs-string">'$xml'</span>, <span class="hljs-string">'$json'</span>, <span class="hljs-string">'$js'</span>], <span class="hljs-function"><span class="hljs-params">(path, cb)</span> -&gt;</span>
          find [path], work, <span class="hljs-function"><span class="hljs-params">(err, val)</span> -&gt;</span>
            result = val
            cb()
        , <span class="hljs-function">-&gt;</span>
          cb <span class="hljs-literal">null</span>, result
      <span class="hljs-keyword">else</span>
        cb()
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="range-selection-in-array">
  <h4>
    <a href="#range-selection-in-array" name="range-selection-in-array" class="pilcrow"></a>
Range selection in array
  </h4>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  <span class="hljs-attribute">range</span>: <span class="hljs-function"><span class="hljs-params">(proto, path, work, cb)</span> -&gt;</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-46" id="section-46"></a>
</div>
<p>split multiple specifiers</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    rows = path.match <span class="hljs-regexp">///
      \d+ <span class="hljs-comment"># first row</span>
      (?:-\d+)? <span class="hljs-comment"># end of row range</span>
      (?:\[[^\]]+\])? <span class="hljs-comment"># column specification</span>
      ///</span>g <span class="hljs-comment">#path.split ','</span>
    result = []
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-47" id="section-47"></a>
</div>
<p>go over rows</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    <span class="hljs-keyword">for</span> row <span class="hljs-keyword">in</span> rows
      row = row.match <span class="hljs-regexp">///
        (\d+) <span class="hljs-comment"># first row</span>
        (?:-(\d+))? <span class="hljs-comment"># end of row range</span>
        (?:\[([^\]]+)\])? <span class="hljs-comment"># column specification</span>
        ///</span> <span class="hljs-comment">#path.split ','</span>
      row.from = parseInt row[<span class="hljs-number">1</span>]
      row.to = <span class="hljs-keyword">if</span> row[<span class="hljs-number">2</span>]? <span class="hljs-keyword">then</span> parseInt row[<span class="hljs-number">2</span>] <span class="hljs-keyword">else</span> row.from
      cols = row[<span class="hljs-number">3</span>]?.split <span class="hljs-string">','</span>
      <span class="hljs-keyword">if</span> cols? <span class="hljs-keyword">and</span> Array.isArray work.data[<span class="hljs-number">1</span>]
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-48" id="section-48"></a>
</div>
<p>get columns</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">        <span class="hljs-keyword">for</span> drow <span class="hljs-keyword">in</span> work.data[row.from..row.to]
          data = []
          <span class="hljs-keyword">for</span> col <span class="hljs-keyword">in</span> cols
            col = col.match <span class="hljs-regexp">///
              (\d+) <span class="hljs-comment"># first column</span>
              (?:-(\d+))? <span class="hljs-comment"># end of column range</span>
              ///</span> <span class="hljs-comment">#path.split ','</span>
            col.from = parseInt col[<span class="hljs-number">1</span>]
            col.to = <span class="hljs-keyword">if</span> col[<span class="hljs-number">2</span>]? <span class="hljs-keyword">then</span> parseInt col[<span class="hljs-number">2</span>] <span class="hljs-keyword">else</span> col.from
            data = data.concat drow[col.from..col.to]
          result.push data
      <span class="hljs-keyword">else</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-49" id="section-49"></a>
</div>
<p>get single row</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">        <span class="hljs-keyword">for</span> drow <span class="hljs-keyword">in</span> work.data[row.from..row.to]
          result.push drow[<span class="hljs-number">0</span>]
    <span class="hljs-keyword">return</span> cb() <span class="hljs-keyword">unless</span> result.length
    result = result[<span class="hljs-number">0</span>] <span class="hljs-keyword">if</span> result.length <span class="hljs-keyword">is</span> <span class="hljs-number">1</span>
    result = result[<span class="hljs-number">0</span>] <span class="hljs-keyword">if</span> result.length <span class="hljs-keyword">is</span> <span class="hljs-number">1</span>
    cb <span class="hljs-literal">null</span>, result
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="path-selection-in-object">
  <h4>
    <a href="#path-selection-in-object" name="path-selection-in-object" class="pilcrow"></a>
Path selection in object
  </h4>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  <span class="hljs-attribute">object</span>: <span class="hljs-function"><span class="hljs-params">(proto, path, work, cb)</span> -&gt;</span>
    cb <span class="hljs-literal">null</span>, object.pathSearch work.data, path
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="join-array-together">
  <h4>
    <a href="#join-array-together" name="join-array-together" class="pilcrow"></a>
Join array together
  </h4>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  <span class="hljs-attribute">join</span>: <span class="hljs-function"><span class="hljs-params">(proto, path, work, cb)</span> -&gt;</span>
    path = path[<span class="hljs-number">6.</span>.]
    splitter = <span class="hljs-keyword">if</span> path <span class="hljs-keyword">then</span> path.split <span class="hljs-string">'//'</span> <span class="hljs-keyword">else</span> [<span class="hljs-string">', '</span>]
    cb <span class="hljs-literal">null</span>, arrayJoin work.data, splitter
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="accessing-environment-variable">
  <h4>
    <a href="#accessing-environment-variable" name="accessing-environment-variable" class="pilcrow"></a>
Accessing environment variable
  </h4>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  <span class="hljs-attribute">env</span>: <span class="hljs-function"><span class="hljs-params">(proto, path, work, cb)</span> -&gt;</span>
    cb <span class="hljs-literal">null</span>, process.env[path]
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="read-from-value-structure">
  <h4>
    <a href="#read-from-value-structure" name="read-from-value-structure" class="pilcrow"></a>
Read from value structure
  </h4>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  <span class="hljs-attribute">struct</span>: <span class="hljs-function"><span class="hljs-params">(proto, path, work, cb)</span> -&gt;</span>
    findData path, work, cb
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="read-from-additional-context">
  <h4>
    <a href="#read-from-additional-context" name="read-from-additional-context" class="pilcrow"></a>
Read from additional context
  </h4>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  <span class="hljs-attribute">context</span>: <span class="hljs-function"><span class="hljs-params">(proto, path, work, cb)</span> -&gt;</span>
    cb <span class="hljs-literal">null</span>, object.pathSearch work.spec?.context, path
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="read-from-file">
  <h4>
    <a href="#read-from-file" name="read-from-file" class="pilcrow"></a>
Read from file
  </h4>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  <span class="hljs-attribute">file</span>: <span class="hljs-function"><span class="hljs-params">(proto, path, work, cb)</span> -&gt;</span>
    fs = <span class="hljs-built_in">require</span> <span class="hljs-string">'alinex-fs'</span>
    fspath = <span class="hljs-built_in">require</span> <span class="hljs-string">'path'</span>
    path = fspath.resolve work.spec.dir, path <span class="hljs-keyword">if</span> work.spec?.dir?
    fs.realpath path, <span class="hljs-function"><span class="hljs-params">(err, path)</span> -&gt;</span>
      <span class="hljs-keyword">return</span> cb err <span class="hljs-keyword">if</span> err
      fs.readFile path, <span class="hljs-string">'utf-8'</span>, cb
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="read-from-web-resource">
  <h4>
    <a href="#read-from-web-resource" name="read-from-web-resource" class="pilcrow"></a>
Read from web resource
  </h4>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  <span class="hljs-attribute">web</span>: <span class="hljs-function"><span class="hljs-params">(proto, path, work, cb)</span> -&gt;</span>
    request = <span class="hljs-built_in">require</span> <span class="hljs-string">'request'</span>
    request
      <span class="hljs-attribute">uri</span>: <span class="hljs-string">"<span class="hljs-subst">#{proto}</span>://<span class="hljs-subst">#{path}</span>"</span>
      <span class="hljs-attribute">followAllRedirects</span>: <span class="hljs-literal">true</span>
    , <span class="hljs-function"><span class="hljs-params">(err, response, body)</span> -&gt;</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-57" id="section-57"></a>
</div>
<p>error checking</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">      <span class="hljs-keyword">return</span> cb err <span class="hljs-keyword">if</span> err
      <span class="hljs-keyword">if</span> response.statusCode <span class="hljs-keyword">isnt</span> <span class="hljs-number">200</span>
        <span class="hljs-keyword">return</span> cb <span class="hljs-keyword">new</span> Error <span class="hljs-string">"Server send wrong return code: <span class="hljs-subst">#{response.statusCode}</span>"</span>
      <span class="hljs-keyword">return</span> cb() <span class="hljs-keyword">unless</span> body?
      cb <span class="hljs-literal">null</span>, body
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="read-from-command-output">
  <h4>
    <a href="#read-from-command-output" name="read-from-command-output" class="pilcrow"></a>
Read from command output
  </h4>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  <span class="hljs-attribute">cmd</span>: <span class="hljs-function"><span class="hljs-params">(proto, path, work, cb)</span> -&gt;</span>
    exec = <span class="hljs-built_in">require</span>(<span class="hljs-string">'child_process'</span>).exec
    opt = {}
    opt.cwd = work.spec.dir <span class="hljs-keyword">if</span> work.spec?.dir?
    exec path, opt, <span class="hljs-function"><span class="hljs-params">(err, result)</span> -&gt;</span>
      <span class="hljs-keyword">return</span> cb err <span class="hljs-keyword">if</span> err
      cb <span class="hljs-literal">null</span>, result.trim()

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="read-from-value-structure-1">
  <h3>
    <a href="#read-from-value-structure-1" name="read-from-value-structure-1" class="pilcrow"></a>
Read from value structure
  </h3>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript"><span class="hljs-function"><span class="hljs-title">findData</span> = <span class="hljs-params">(path, work, cb)</span> -&gt;</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-60" id="section-60"></a>
</div>
<p>split path</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  path = path.replace(<span class="hljs-string">'/\/+$/'</span>, <span class="hljs-string">''</span>).split <span class="hljs-regexp">/\/+/</span> <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> path <span class="hljs-keyword">is</span> <span class="hljs-string">'string'</span>
  work.path ?= []
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-61" id="section-61"></a>
</div>
<p>find first level</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  first = path[<span class="hljs-number">0</span>]
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-62" id="section-62"></a>
</div>
<p>absolute path, go on</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  <span class="hljs-keyword">return</span> cb <span class="hljs-literal">null</span>, object.pathSearch work.data, path[<span class="hljs-number">1.</span>.] <span class="hljs-keyword">if</span> first <span class="hljs-keyword">is</span> <span class="hljs-string">''</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-63" id="section-63"></a>
</div>
<p>search at current position</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  skip = <span class="hljs-number">0</span>
  skip++ <span class="hljs-keyword">while</span> path[skip] <span class="hljs-keyword">is</span> <span class="hljs-string">'..'</span>
  result = object.pathSearch work.data, work.path[<span class="hljs-number">0.</span>.work.path.length-skip-<span class="hljs-number">1</span>].concat path[skip..]
  <span class="hljs-keyword">if</span> result <span class="hljs-keyword">and</span> work.spec?.done?
    checkpath = work.path[<span class="hljs-number">0.</span>.work.path.length-skip-<span class="hljs-number">1</span>].concat(path[skip..]).join <span class="hljs-string">'/'</span>
    <span class="hljs-keyword">unless</span> checkpath <span class="hljs-keyword">in</span> work.spec.done
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-64" id="section-64"></a>
</div>
<p>check for retry</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">      work.retry ?= <span class="hljs-number">0</span>
      <span class="hljs-keyword">if</span> work.retry &gt; MAXRETRY/TIMEOUT
        work.spec.failed = <span class="hljs-literal">true</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">throw</span> Error <span class="hljs-string">"Stopped because of uncheckable <span class="hljs-subst">#{work.spec.name}</span>/<span class="hljs-subst">#{checkpath}</span>"</span>
      <span class="hljs-keyword">return</span> setTimeout -&gt;
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> work.spec.failed <span class="hljs-comment"># processing already stopped</span>
        work.retry++
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-65" id="section-65"></a>
</div>
<p>reread value from spec</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">        work.data = work.spec.value
        findData path, work, cb
      , TIMEOUT
  <span class="hljs-keyword">return</span> cb <span class="hljs-literal">null</span>, result <span class="hljs-keyword">if</span> result
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-66" id="section-66"></a>
</div>
<p>check if not at the end</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  <span class="hljs-keyword">return</span> cb() <span class="hljs-keyword">unless</span> work.path.length
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-67" id="section-67"></a>
</div>
<p>search neighbors by sub call on parent</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  sub = object.clone work
  sub.spec = work.spec
  sub.path.pop()
  findData path, sub, cb

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="recursively-join-array-of-arrays-together">
  <h3>
    <a href="#recursively-join-array-of-arrays-together" name="recursively-join-array-of-arrays-together" class="pilcrow"></a>
Recursively join array of arrays together
  </h3>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript"><span class="hljs-function"><span class="hljs-title">arrayJoin</span> = <span class="hljs-params">(data, splitter)</span> -&gt;</span>
  glue = <span class="hljs-keyword">if</span> splitter.length <span class="hljs-keyword">is</span> <span class="hljs-number">1</span> <span class="hljs-keyword">then</span> splitter[<span class="hljs-number">0</span>] <span class="hljs-keyword">else</span> splitter.shift()
  result = <span class="hljs-string">''</span>
  <span class="hljs-keyword">for</span> v <span class="hljs-keyword">in</span> data
    v = arrayJoin v, splitter <span class="hljs-keyword">if</span> Array.isArray v
    result += glue <span class="hljs-keyword">if</span> result
    result += v
  result

</pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>
