<!DOCTYPE html>
<html>
<head>
  <title>reference.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../doc-style.css" />
  <script src="../doc-filelist.js"></script>
  <script>
    var relativeDir = "../", thisFile = "home/alex/a3/node-validator/src/referencecoffee", defaultSidebar = true;
  </script>
  <script src="../doc-script.js"></script>
  <script src="../fileSearch.js"></script>
  <script src="../goToLine.js"></script>
  <link rel="stylesheet" href="../fileSearch.css" />
  <link rel="stylesheet" href="../goToLine.css" />
</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">
      <div class="heading h1">
        <a href="#ip%20address%20validation">IP Address validation</a>
      </div>
      <div class="heading h2">
        <a href="#node%20modules">Node modules</a>
      </div>
      <div class="heading h2">
        <a href="#configuration">Configuration</a>
      </div>
      <div class="heading h2">
        <a href="#helper%20methods">Helper methods</a>
      </div>
    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container" tabindex="0"><a id="fork" href="https://github.com/alinex/node-validator" title="Fork me on GitHub"></a><div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
      <tr>
        <td class="docs">
<div class="pilwrap" id="ip%20address%20validation">
  <h1>
    <a href="#ip%20address%20validation" name="ip%20address%20validation" class="pilcrow">&#182;</a>
    IP Address validation
  </h1>
</div>

        </td>
        <td class="code highlight"><div class="highlight"><pre></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2">&#182;</a>
</div>
<p>work values</p>

<ul>
<li>lastType - the type of the last checked reference to ensure security</li>
<li>data - structure to work on</li>
<li>pos - array defining the current position in data</li>
<li>dir - set to base directory for file relative file paths</li>
<li>structSearch - set if first element is done (within findData())</li>
<li>context - alternative data object</li>
</ul>
        </td>
        <td class="code highlight"><div class="highlight"><pre>



</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="node%20modules">
  <h2>
    <a href="#node%20modules" name="node%20modules" class="pilcrow">&#182;</a>
    Node modules
  </h2>
</div>

        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nv">debug = </span><span class="nx">require</span><span class="p">(</span><span class="s">&#39;debug&#39;</span><span class="p">)(</span><span class="s">&#39;validator:reference&#39;</span><span class="p">)</span>
<span class="nv">util = </span><span class="nx">require</span> <span class="s">&#39;util&#39;</span>
<span class="nv">chalk = </span><span class="nx">require</span> <span class="s">&#39;chalk&#39;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4">&#182;</a>
</div>
<p>alinex modules</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nv">async = </span><span class="nx">require</span> <span class="s">&#39;alinex-async&#39;</span>
<span class="p">{</span><span class="nx">object</span><span class="p">,</span><span class="nx">array</span><span class="p">}</span> <span class="o">=</span> <span class="nx">require</span> <span class="s">&#39;alinex-util&#39;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5">&#182;</a>
</div>
<p>include classes and helper</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nv">ValidatorCheck = </span><span class="nx">require</span> <span class="s">&#39;./check&#39;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="configuration">
  <h2>
    <a href="#configuration" name="configuration" class="pilcrow">&#182;</a>
    Configuration
  </h2>
</div>


<p>defines specific type handler for some protocols</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nv">protocolMap =</span>
  <span class="nv">http: </span><span class="s">&#39;web&#39;</span>
  <span class="nv">https: </span><span class="s">&#39;web&#39;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-7" id="section-7">&#182;</a>
</div>
<p>to ensure security a reference can only call references with lower precedence</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nv">typePrecedence =</span>
  <span class="nv">env: </span><span class="mi">5</span>
  <span class="nv">struct: </span><span class="mi">4</span>
  <span class="nv">context : </span><span class="mi">3</span>
  <span class="nv">file: </span><span class="mi">2</span>
  <span class="nv">cmd: </span><span class="mi">2</span>
  <span class="nv">web: </span><span class="mi">1</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="helper%20methods">
  <h2>
    <a href="#helper%20methods" name="helper%20methods" class="pilcrow">&#182;</a>
    Helper methods
  </h2>
</div>

        </td>
        <td class="code highlight"><div class="highlight"><pre>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-9" id="section-9">&#182;</a>
</div>
<p>check that there are references in the object</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nv">exists = module.exports.exists = </span><span class="nf">(value) -&gt;</span>
  <span class="k">return</span> <span class="kc">false</span> <span class="k">unless</span> <span class="k">typeof</span> <span class="nx">value</span> <span class="o">is</span> <span class="s">&#39;string&#39;</span>
  <span class="nb">Boolean</span> <span class="nx">value</span><span class="p">.</span><span class="nx">match</span> <span class="sr">/&lt;&lt;&lt;.*&gt;&gt;&gt;/</span>

<span class="nv">replace = module.exports.replace = </span><span class="nf">(value, work={}, cb) -&gt;</span>
  <span class="k">if</span> <span class="k">typeof</span> <span class="nx">work</span> <span class="o">is</span> <span class="s">&#39;function&#39;</span>
    <span class="nv">cb = </span><span class="nx">work</span>
    <span class="nv">work = </span><span class="p">{}</span>
  <span class="k">return</span> <span class="nx">cb</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">value</span> <span class="k">unless</span> <span class="nx">exists</span> <span class="nx">value</span>
  <span class="nx">debug</span> <span class="s">&quot;replace </span><span class="si">#{</span><span class="nx">util</span><span class="p">.</span><span class="nx">inspect</span> <span class="nx">value</span><span class="si">}</span><span class="s">...&quot;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-10" id="section-10">&#182;</a>
</div>
<p>step over parts</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="nv">refs = </span><span class="nx">value</span><span class="p">.</span><span class="nx">split</span> <span class="sr">/(&lt;&lt;&lt;.*?&gt;&gt;&gt;)/</span>
  <span class="nv">refs = </span><span class="p">[</span><span class="nx">refs</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="k">if</span> <span class="nx">refs</span><span class="p">.</span><span class="nx">length</span> <span class="o">is</span> <span class="mi">3</span> <span class="o">and</span> <span class="nx">refs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">is</span> <span class="s">&#39;&#39;</span> <span class="o">and</span> <span class="nx">refs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">is</span> <span class="s">&#39;&#39;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-11" id="section-11">&#182;</a>
</div>
<p>check alternatives</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="nx">async</span><span class="p">.</span><span class="nx">map</span> <span class="nx">refs</span><span class="p">,</span> <span class="nf">(v, cb) -&gt;</span>
    <span class="nx">findAlternative</span> <span class="nx">v</span><span class="p">,</span> <span class="nx">work</span><span class="p">,</span> <span class="nx">cb</span>
  <span class="p">,</span> <span class="nf">(err, results) -&gt;</span>
    <span class="k">return</span> <span class="nx">cb</span><span class="p">()</span> <span class="k">if</span> <span class="nx">err</span>
    <span class="k">if</span> <span class="nx">results</span><span class="p">.</span><span class="nx">length</span> <span class="o">is</span> <span class="mi">1</span>
      <span class="nx">debug</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">util</span><span class="p">.</span><span class="nx">inspect</span> <span class="nx">value</span><span class="si">}</span><span class="s"> is replaced by </span><span class="si">#{</span><span class="nx">util</span><span class="p">.</span><span class="nx">inspect</span> <span class="nx">results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s">&quot;</span>
      <span class="k">return</span> <span class="nx">cb</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-12" id="section-12">&#182;</a>
</div>
<p>combine together</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nv">result = </span><span class="nx">results</span><span class="p">.</span><span class="nx">join</span> <span class="s">&#39;&#39;</span>
    <span class="nx">debug</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">util</span><span class="p">.</span><span class="nx">inspect</span> <span class="nx">value</span><span class="si">}</span><span class="s"> is replaced by </span><span class="si">#{</span><span class="nx">util</span><span class="p">.</span><span class="nx">inspect</span> <span class="nx">result</span><span class="si">}</span><span class="s">&quot;</span>
    <span class="nx">cb</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">result</span>


<span class="nv">findAlternative = </span><span class="nf">(value, work={}, cb) -&gt;</span>
  <span class="k">return</span> <span class="nx">cb</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">value</span> <span class="k">unless</span> <span class="o">~</span><span class="nx">value</span><span class="p">.</span><span class="nx">indexOf</span> <span class="s">&#39;&lt;&lt;&lt;&#39;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-13" id="section-13">&#182;</a>
</div>
<p>replace &lt;&lt;&lt; and >>> and split into alternatives</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="nx">async</span><span class="p">.</span><span class="nx">map</span> <span class="nx">value</span><span class="p">[</span><span class="mi">3</span><span class="p">..</span><span class="o">-</span><span class="mi">4</span><span class="p">].</span><span class="nx">split</span><span class="p">(</span><span class="sr">/\s+\|\s+/</span><span class="p">),</span> <span class="nf">(alt, cb) -&gt;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-14" id="section-14">&#182;</a>
</div>
<p>split into paths and call</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nv">uris = </span><span class="nx">alt</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="sr">/#/</span><span class="p">)</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-15" id="section-15">&#182;</a>
</div>
<p>return default value</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">if</span> <span class="nx">uris</span><span class="p">.</span><span class="nx">length</span> <span class="o">is</span> <span class="mi">1</span> <span class="o">and</span> <span class="o">not</span> <span class="o">~</span><span class="nx">alt</span><span class="p">.</span><span class="nx">indexOf</span> <span class="s">&#39;://&#39;</span>
      <span class="nx">debug</span> <span class="nx">chalk</span><span class="p">.</span><span class="nx">grey</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">util</span><span class="p">.</span><span class="nx">inspect</span> <span class="nx">alt</span><span class="si">}</span><span class="s"> -&gt; default value: </span><span class="si">#{</span><span class="nx">util</span><span class="p">.</span><span class="nx">inspect</span> <span class="nx">alt</span><span class="si">}</span><span class="s">&quot;</span>
      <span class="k">return</span> <span class="nx">cb</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">alt</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-16" id="section-16">&#182;</a>
</div>
<p>search the uris</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">find</span> <span class="nx">uris</span><span class="p">,</span> <span class="nx">work</span><span class="p">,</span> <span class="nf">(err, result) -&gt;</span>
      <span class="k">if</span> <span class="nx">err</span>
        <span class="nx">debug</span> <span class="nx">chalk</span><span class="p">.</span><span class="nx">grey</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">util</span><span class="p">.</span><span class="nx">inspect</span> <span class="nx">alt</span><span class="si">}</span><span class="s"> -&gt; failed: </span><span class="si">#{</span><span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="si">}</span><span class="s">&quot;</span>
        <span class="k">return</span> <span class="nx">cb</span> <span class="nx">err</span>
      <span class="nx">debug</span> <span class="nx">chalk</span><span class="p">.</span><span class="nx">grey</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">util</span><span class="p">.</span><span class="nx">inspect</span> <span class="nx">alt</span><span class="si">}</span><span class="s"> -&gt; result: </span><span class="si">#{</span><span class="nx">util</span><span class="p">.</span><span class="nx">inspect</span> <span class="nx">result</span><span class="si">}</span><span class="s">&quot;</span>
      <span class="nx">cb</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">result</span>
  <span class="p">,</span> <span class="nf">(err, results) -&gt;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-17" id="section-17">&#182;</a>
</div>
<p>find first alternative</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">for</span> <span class="nx">result</span> <span class="k">in</span> <span class="nx">results</span>
      <span class="k">return</span> <span class="nx">cb</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">result</span> <span class="k">if</span> <span class="nx">result</span><span class="o">?</span>
    <span class="nx">cb</span><span class="p">()</span>

<span class="nv">find = </span><span class="nf">(list, work={}, cb) -&gt;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-18" id="section-18">&#182;</a>
</div>
<p>get first element of path</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="p">[</span><span class="nx">proto</span><span class="p">,</span><span class="nx">path</span><span class="p">]</span> <span class="o">=</span> <span class="nx">list</span><span class="p">.</span><span class="nx">shift</span><span class="p">().</span><span class="nx">split</span> <span class="sr">/:\/\//</span>
  <span class="k">unless</span> <span class="nx">path</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-19" id="section-19">&#182;</a>
</div>
<p>return if no data to work on</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">return</span> <span class="nx">cb</span><span class="p">()</span> <span class="k">unless</span> <span class="nx">work</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-20" id="section-20">&#182;</a>
</div>
<p>set protocol missing uris</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nv">path = </span><span class="nx">proto</span>
    <span class="nv">proto = </span><span class="k">switch</span>
      <span class="k">when</span> <span class="nx">path</span><span class="p">.</span><span class="nx">trim</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">is</span> <span class="s">&#39;{&#39;</span>
        <span class="s">&#39;check&#39;</span>
      <span class="k">when</span> <span class="nx">work</span><span class="p">.</span><span class="nx">data</span> <span class="o">is</span> <span class="s">&#39;string&#39;</span>
        <span class="s">&#39;range&#39;</span>
      <span class="k">else</span>
        <span class="s">&#39;match&#39;</span>
  <span class="nx">debug</span> <span class="nx">chalk</span><span class="p">.</span><span class="nx">grey</span> <span class="s">&quot;check part </span><span class="si">#{</span><span class="nx">proto</span><span class="si">}</span><span class="s">://</span><span class="si">#{</span><span class="nx">path</span><span class="si">}</span><span class="s">&quot;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-21" id="section-21">&#182;</a>
</div>
<p>find type handler</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="nv">proto = </span><span class="nx">proto</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span>
  <span class="nv">type = </span><span class="nx">protocolMap</span><span class="p">[</span><span class="nx">proto</span><span class="p">]</span> <span class="o">?</span> <span class="nx">proto</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-22" id="section-22">&#182;</a>
</div>
<p>check for correct handler</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="k">unless</span> <span class="nx">findType</span><span class="p">[</span><span class="nx">type</span><span class="p">]</span><span class="o">?</span>
    <span class="k">return</span> <span class="nx">cb</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s">&quot;No handler for protocol </span><span class="si">#{</span><span class="nx">proto</span><span class="si">}</span><span class="s"> for references defined&quot;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-23" id="section-23">&#182;</a>
</div>
<p>check precedence for next uri</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="k">if</span> <span class="nx">work</span><span class="p">.</span><span class="nx">lastType</span><span class="o">?</span> <span class="o">and</span> <span class="nx">typePrecedence</span><span class="p">[</span><span class="nx">type</span><span class="p">]</span> <span class="o">&gt;</span> <span class="nx">typePrecedence</span><span class="p">[</span><span class="nx">work</span><span class="p">.</span><span class="nx">lastType</span><span class="o">?</span><span class="p">]</span>
    <span class="k">return</span> <span class="nx">cb</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">next</span><span class="si">}</span><span class="s">-reference can not be called from </span><span class="si">#{</span><span class="nx">proto</span><span class="si">}</span><span class="s">-reference</span>
<span class="s">    for security reasons&quot;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-24" id="section-24">&#182;</a>
</div>
<p>run type handler and return if nothing found</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="nv">work.lastType = </span><span class="nx">type</span>
  <span class="nx">findType</span><span class="p">[</span><span class="nx">type</span><span class="p">]</span> <span class="nx">proto</span><span class="p">,</span> <span class="nx">path</span><span class="p">,</span> <span class="nx">work</span><span class="p">,</span> <span class="nf">(err, result) -&gt;</span>
    <span class="k">return</span> <span class="nx">cb</span> <span class="nx">err</span> <span class="k">if</span> <span class="nx">err</span>
    <span class="k">unless</span> <span class="nx">exists</span> <span class="nx">result</span>
      <span class="k">return</span> <span class="nx">cb</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">result</span> <span class="k">unless</span> <span class="nx">list</span><span class="p">.</span><span class="nx">length</span>
      <span class="nx">debug</span> <span class="nx">chalk</span><span class="p">.</span><span class="nx">grey</span> <span class="s">&quot;&#39;</span><span class="si">#{</span><span class="nx">proto</span><span class="si">}</span><span class="s">://</span><span class="si">#{</span><span class="nx">path</span><span class="si">}</span><span class="s">&#39; -&gt; result: </span><span class="si">#{</span><span class="nx">util</span><span class="p">.</span><span class="nx">inspect</span> <span class="nx">result</span><span class="si">}</span><span class="s">&quot;</span>
      <span class="nv">work = </span><span class="nx">object</span><span class="p">.</span><span class="nx">extend</span> <span class="p">{},</span> <span class="nx">work</span><span class="p">,</span>
        <span class="nv">data: </span><span class="nx">result</span>
        <span class="nv">pos: </span><span class="kc">undefined</span>
      <span class="nx">find</span> <span class="nx">list</span><span class="p">,</span> <span class="nx">work</span><span class="p">,</span> <span class="nx">cb</span>
    <span class="nx">debug</span> <span class="nx">chalk</span><span class="p">.</span><span class="nx">grey</span> <span class="s">&#39;rerun replace on subdata&#39;</span>
    <span class="nx">replace</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">object</span><span class="p">.</span><span class="nx">clone</span><span class="p">(</span><span class="nx">work</span><span class="p">),</span> <span class="nf">(err, result) -&gt;</span>
      <span class="k">return</span> <span class="nx">cb</span> <span class="nx">err</span> <span class="k">if</span> <span class="nx">err</span>
      <span class="k">return</span> <span class="nx">cb</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">result</span> <span class="k">unless</span> <span class="nx">list</span><span class="p">.</span><span class="nx">length</span>
      <span class="nx">debug</span> <span class="nx">chalk</span><span class="p">.</span><span class="nx">grey</span> <span class="s">&quot;&#39;</span><span class="si">#{</span><span class="nx">proto</span><span class="si">}</span><span class="s">://</span><span class="si">#{</span><span class="nx">path</span><span class="si">}</span><span class="s">&#39; -&gt; result: </span><span class="si">#{</span><span class="nx">util</span><span class="p">.</span><span class="nx">inspect</span> <span class="nx">result</span><span class="si">}</span><span class="s">&quot;</span>
      <span class="nv">work = </span><span class="nx">object</span><span class="p">.</span><span class="nx">extend</span> <span class="p">{},</span> <span class="nx">work</span><span class="p">,</span>
        <span class="nv">data: </span><span class="nx">result</span>
        <span class="nv">pos: </span><span class="kc">undefined</span>
      <span class="nx">find</span> <span class="nx">list</span><span class="p">,</span> <span class="nx">work</span><span class="p">,</span> <span class="nx">cb</span>

<span class="nv">findType =</span>
  <span class="nv">check: </span> <span class="nf">(proto, path, work, cb) -&gt;</span>
    <span class="nv">vm = </span><span class="nx">require</span> <span class="s">&#39;vm&#39;</span>
    <span class="nv">check = </span><span class="nx">util</span><span class="p">.</span><span class="nx">inspect</span> <span class="nx">vm</span><span class="p">.</span><span class="nx">runInNewContext</span> <span class="s">&quot;x=</span><span class="si">#{</span><span class="nx">path</span><span class="si">}</span><span class="s">&quot;</span>
    <span class="p">(</span><span class="k">new</span> <span class="nx">ValidatorCheck</span> <span class="s">&#39;work.refname&#39;</span><span class="p">,</span> <span class="nx">check</span><span class="p">,</span> <span class="nx">work</span><span class="p">.</span><span class="nx">data</span><span class="p">).</span><span class="nx">async</span> <span class="nx">cb</span>
  <span class="nv">range: </span> <span class="nf">(proto, path, work, cb) -&gt;</span>
    <span class="nx">value</span>
  <span class="nv">match: </span> <span class="nf">(proto, path, work, cb) -&gt;</span>
    <span class="nx">value</span>
  <span class="nv">env: </span><span class="nf">(proto, path, work, cb) -&gt;</span>
    <span class="nx">cb</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">[</span><span class="nx">path</span><span class="p">]</span>
  <span class="nv">struct: </span><span class="nf">(proto, path, work, cb) -&gt;</span>
    <span class="nx">cb</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">findData</span> <span class="nx">path</span><span class="p">,</span> <span class="nx">work</span>
  <span class="nv">context: </span><span class="nf">(proto, path, work, cb) -&gt;</span>
    <span class="nx">cb</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">findData</span> <span class="nx">path</span><span class="p">,</span> <span class="nx">object</span><span class="p">.</span><span class="nx">extend</span> <span class="p">{},</span> <span class="nx">work</span><span class="p">,</span>
      <span class="nv">data: </span><span class="nx">work</span><span class="p">.</span><span class="nx">context</span>
  <span class="nv">file: </span><span class="nf">(proto, path, work, cb) -&gt;</span>
    <span class="nv">fs = </span><span class="nx">require</span> <span class="s">&#39;alinex-fs&#39;</span>
    <span class="nv">fspath = </span><span class="nx">require</span> <span class="s">&#39;path&#39;</span>
    <span class="nv">path = </span><span class="nx">fspath</span><span class="p">.</span><span class="nx">resolve</span> <span class="nx">work</span><span class="p">.</span><span class="nx">dir</span><span class="p">,</span> <span class="nx">path</span> <span class="k">if</span> <span class="nx">work</span><span class="p">.</span><span class="nx">dir</span><span class="o">?</span>
    <span class="nx">fs</span><span class="p">.</span><span class="nx">realpath</span> <span class="nx">path</span><span class="p">,</span> <span class="nf">(err, path) -&gt;</span>
      <span class="k">return</span> <span class="nx">cb</span> <span class="nx">err</span> <span class="k">if</span> <span class="nx">err</span>
      <span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span> <span class="nx">path</span><span class="p">,</span> <span class="s">&#39;utf-8&#39;</span><span class="p">,</span> <span class="nx">cb</span>
  <span class="nv">web: </span><span class="nf">(proto, path, work, cb) -&gt;</span>
    <span class="nv">request = </span><span class="nx">require</span> <span class="s">&#39;request&#39;</span>
    <span class="nx">request</span>
      <span class="nv">uri: </span><span class="s">&quot;</span><span class="si">#{</span><span class="nx">proto</span><span class="si">}</span><span class="s">://</span><span class="si">#{</span><span class="nx">path</span><span class="si">}</span><span class="s">&quot;</span>
      <span class="nv">followAllRedirects: </span><span class="kc">true</span>
    <span class="p">,</span> <span class="nf">(err, response, body) -&gt;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-25" id="section-25">&#182;</a>
</div>
<p>error checking</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="k">return</span> <span class="nx">cb</span> <span class="nx">err</span> <span class="k">if</span> <span class="nx">err</span>
      <span class="k">if</span> <span class="nx">response</span><span class="p">.</span><span class="nx">statusCode</span> <span class="o">isnt</span> <span class="mi">200</span>
        <span class="k">return</span> <span class="nx">cb</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s">&quot;Server send wrong return code: </span><span class="si">#{</span><span class="nx">response</span><span class="p">.</span><span class="nx">statusCode</span><span class="si">}</span><span class="s">&quot;</span>
      <span class="k">return</span> <span class="nx">cb</span><span class="p">()</span> <span class="k">unless</span> <span class="nx">body</span><span class="o">?</span>
      <span class="nx">cb</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">body</span>
  <span class="nv">cmd: </span><span class="nf">(proto, path, work, cb) -&gt;</span>
    <span class="nv">exec = </span><span class="nx">require</span><span class="p">(</span><span class="s">&#39;child_process&#39;</span><span class="p">).</span><span class="nx">exec</span>
    <span class="nv">opt = </span><span class="p">{}</span>
    <span class="nv">opt.cwd = </span><span class="nx">work</span><span class="p">.</span><span class="nx">dir</span> <span class="k">if</span> <span class="nx">work</span><span class="p">.</span><span class="nx">dir</span><span class="o">?</span>
    <span class="nx">exec</span> <span class="nx">path</span><span class="p">,</span> <span class="nx">opt</span><span class="p">,</span> <span class="nx">cb</span>


<span class="nv">findData = </span><span class="nf">(path, work) -&gt;</span>
  <span class="k">unless</span> <span class="nx">work</span><span class="p">.</span><span class="nx">structSearch</span><span class="o">?</span>
    <span class="nv">work = </span><span class="nx">object</span><span class="p">.</span><span class="nx">clone</span> <span class="nx">work</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-26" id="section-26">&#182;</a>
</div>
<p>split path</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="nv">path = </span><span class="nx">path</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="s">&#39;/\/+$/&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">).</span><span class="nx">split</span> <span class="sr">/\/+/</span> <span class="k">if</span> <span class="k">typeof</span> <span class="nx">path</span> <span class="o">is</span> <span class="s">&#39;string&#39;</span>
  <span class="nx">work</span><span class="p">.</span><span class="nx">pos</span> <span class="o">?=</span> <span class="p">[]</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-27" id="section-27">&#182;</a>
</div>
<p>process first level</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="nv">cur = </span><span class="nx">path</span><span class="p">.</span><span class="nx">shift</span><span class="p">()</span>
  <span class="k">if</span> <span class="nx">cur</span> <span class="o">is</span> <span class="s">&#39;&#39;</span>
    <span class="nv">work.pos = </span><span class="p">[]</span>
  <span class="k">else</span>
    <span class="k">if</span> <span class="nx">getData</span><span class="p">(</span><span class="nx">work</span><span class="p">.</span><span class="nx">data</span><span class="p">,</span> <span class="nx">work</span><span class="p">.</span><span class="nx">pos</span><span class="p">)</span><span class="o">?</span><span class="p">[</span><span class="nx">cur</span><span class="p">]</span><span class="o">?</span>
      <span class="nx">work</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">push</span> <span class="nx">cur</span>
    <span class="k">else</span>
      <span class="k">return</span> <span class="kc">undefined</span> <span class="k">if</span> <span class="nx">work</span><span class="p">.</span><span class="nx">structSearch</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-28" id="section-28">&#182;</a>
</div>
<p>search backwards neighbors and parent</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="nv">done = </span><span class="kc">false</span>
      <span class="k">if</span> <span class="nx">work</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="nx">work</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">2</span><span class="p">..</span><span class="mi">0</span><span class="p">]</span>
          <span class="k">if</span> <span class="nx">getData</span><span class="p">(</span><span class="nx">work</span><span class="p">.</span><span class="nx">data</span><span class="p">,</span> <span class="nx">work</span><span class="p">.</span><span class="nx">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">..</span><span class="nx">i</span><span class="p">])[</span><span class="nx">cur</span><span class="p">]</span><span class="o">?</span>
            <span class="nv">work.pos = </span><span class="nx">work</span><span class="p">.</span><span class="nx">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">..</span><span class="nx">i</span><span class="p">]</span>
            <span class="nx">work</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">push</span> <span class="nx">cur</span>
            <span class="nv">done = </span><span class="kc">true</span>
            <span class="k">break</span>
      <span class="k">unless</span> <span class="nx">done</span>
        <span class="k">if</span> <span class="nx">work</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="nx">cur</span><span class="p">]</span><span class="o">?</span>
          <span class="nv">work.pos = </span><span class="p">[</span><span class="nx">cur</span><span class="p">]</span>
          <span class="nv">done = </span><span class="kc">true</span>
      <span class="k">return</span> <span class="kc">undefined</span> <span class="k">unless</span> <span class="nx">done</span>
  <span class="nv">work.structSearch = </span><span class="kc">true</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-29" id="section-29">&#182;</a>
</div>
<p>go on for more level if existing</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="k">return</span> <span class="nx">findData</span> <span class="nx">path</span><span class="p">,</span> <span class="nx">work</span> <span class="k">if</span> <span class="nx">path</span><span class="p">.</span><span class="nx">length</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-30" id="section-30">&#182;</a>
</div>
<p>if not use the current path and return this value</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="nx">getData</span> <span class="nx">work</span><span class="p">.</span><span class="nx">data</span><span class="p">,</span> <span class="nx">work</span><span class="p">.</span><span class="nx">pos</span>

<span class="nv">getData = </span><span class="nf">(data, pos) -&gt;</span>
  <span class="k">return</span> <span class="nx">data</span> <span class="k">unless</span> <span class="nx">pos</span><span class="p">.</span><span class="nx">length</span>
  <span class="nv">result = </span><span class="nx">data</span>
  <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">..</span><span class="nx">pos</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-31" id="section-31">&#182;</a>
</div>
<p>console.log '-->', result, pos[i]</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nv">result = </span><span class="nx">result</span><span class="p">[</span><span class="nx">pos</span><span class="p">[</span><span class="nx">i</span><span class="p">]]</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-32" id="section-32">&#182;</a>
</div>
<p>console.log '--=', result</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="k">return</span> <span class="nx">result</span>
</pre></div>
        </td>
      </tr>
  </tbody>
</table>
  </div>
</body>
</html>
