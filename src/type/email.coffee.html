<!DOCTYPE html>
<html>
<head>
  <title>email.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../doc-style.css" />
  <script src="../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../";
    var thisFile = "home/alex/github/node-validator/src/type/email.coffee";
    var defaultSidebar = true;
  </script>
  <script src="../../doc-script.js"></script>

<meta name="viewport" content="width=device-width, initial-scale=1.0" /></head
<body>
  <nav>
<div class="logo"><a href="http://alinex.github.io"
  onmouseover="logo.src='https://alinex.github.io/images/Alinex-200.png'"
  onmouseout="logo.src='https://alinex.github.io/images/Alinex-black-200.png'">
  <img name="logo" src="https://alinex.github.io/images/Alinex-black-200.png"
    width="150" title="Alinex Universe Homepage" />
  </a>
  <img src="http://alinex.github.io/images/Alinex-200.png"
    style="display:none" alt="preloading" />
</div>
<div class="links">
  <a href="http://alinex.github.io/blog"
    class="btn btn-primary"><span class="glyphicon-pencil"></span> Blog</a>
  <a href="http://alinex.github.io/develop"
    class="btn btn-primary"><span class="glyphicon-book"></span> Develop</a>
  <a href="http://alinex.github.io/code.html"
    class="btn btn-warning"><span class="glyphicon-cog"></span> Code</a>
</div>
</nav><div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

      <div class="heading h1">
        <a href="#email-validation">Email validation</a>
      </div>

      <div class="heading h2">
        <a href="#node-modules">Node modules</a>
      </div>

      <div class="heading h2">
        <a href="#subchecks">Subchecks</a>
      </div>

      <div class="heading h2">
        <a href="#host-specific-normalization">Host specific normalization</a>
      </div>

      <div class="heading h2">
        <a href="#type-implementation">Type implementation</a>
      </div>

      <div class="heading h2">
        <a href="#schema-check">Schema check</a>
      </div>

      <div class="heading h2">
        <a href="#helper">Helper</a>
      </div>

      <div class="heading h3">
        <a href="#get-own-ip">get own IP</a>
      </div>

      <div class="heading h3">
        <a href="#contact-the-server">contact the server</a>
      </div>

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container" tabindex="0"><a id="fork" href="https://github.com/alinex/node-validator" title="Fork me on GitHub"></a>
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="email-validation">
  <h1>
    <a href="#email-validation" name="email-validation" class="pilcrow"></a>
Email validation
  </h1>
</div>
<p>There are a lot of crazy possibilities in the RFC2822 which  specifies the Email
format. Perhaps it came from letting different existing email systems represented
their account, to encompass anything that was valid before.</p>
<p>So this check will not aim to allow all emails allowed through RFC but only
those which are reasonable and commonly used.</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2"></a>
</div>
<p>Check options:</p>
<ul>
<li><code>lowerCase</code> domain and gmail addresses completely</li>
<li><code>normalize</code> (boolean) remove tags, alternative domains and subdomains</li>
<li><code>checkServer</code> (boolean) also check for working email servers</li>
</ul>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="node-modules">
  <h2>
    <a href="#node-modules" name="node-modules" class="pilcrow"></a>
Node modules
  </h2>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">debug = <span class="hljs-built_in">require</span>(<span class="hljs-string">'debug'</span>)(<span class="hljs-string">'validator:email'</span>)
util = <span class="hljs-built_in">require</span> <span class="hljs-string">'util'</span>
chalk = <span class="hljs-built_in">require</span> <span class="hljs-string">'chalk'</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4"></a>
</div>
<p>alinex modules</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">object = <span class="hljs-built_in">require</span>(<span class="hljs-string">'alinex-util'</span>).object
async = <span class="hljs-built_in">require</span> <span class="hljs-string">'alinex-async'</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5"></a>
</div>
<p>include classes and helper</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">check = <span class="hljs-built_in">require</span> <span class="hljs-string">'../check'</span>

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="subchecks">
  <h2>
    <a href="#subchecks" name="subchecks" class="pilcrow"></a>
Subchecks
  </h2>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">subcheck =
  <span class="hljs-attribute">type</span>: <span class="hljs-string">'string'</span>
  <span class="hljs-attribute">minLength</span>: <span class="hljs-number">5</span>

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="host-specific-normalization">
  <h2>
    <a href="#host-specific-normalization" name="host-specific-normalization" class="pilcrow"></a>
Host specific normalization
  </h2>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript"><span class="hljs-function"><span class="hljs-title">normalize</span> = <span class="hljs-params">(host)</span> -&gt;</span>
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">switch</span>
    <span class="hljs-keyword">when</span> host.match <span class="hljs-regexp">/^g(oogle)?mail\.com$/i</span>
      (local) -&gt;
        [local.replace(<span class="hljs-regexp">/\.|\+.*$/g</span>, <span class="hljs-string">''</span>), <span class="hljs-string">'gmail.com'</span>]
    <span class="hljs-keyword">else</span>
      (local, host) -&gt;
        [local.replace(<span class="hljs-regexp">/\+.*$/g</span>, <span class="hljs-string">''</span>), host.replace(<span class="hljs-regexp">/.*?(\w+\.\w+)$/</span>, <span class="hljs-string">'$1'</span>)]

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="type-implementation">
  <h2>
    <a href="#type-implementation" name="type-implementation" class="pilcrow"></a>
Type implementation
  </h2>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">exports.describe = <span class="hljs-function"><span class="hljs-params">(work, cb)</span> -&gt;</span>
  text = <span class="hljs-string">'A reasonable working email address. '</span>
  text += check.optional.describe work
  text = text.replace <span class="hljs-regexp">/\. It's/</span>, <span class="hljs-string">' which is'</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-9" id="section-9"></a>
</div>
<p>subcheck</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  name = work.spec.name ? <span class="hljs-string">'value'</span>
  <span class="hljs-keyword">if</span> work.path.length
    name += <span class="hljs-string">"/<span class="hljs-subst">#{work.path.join <span class="hljs-string">'/'</span>}</span>"</span>
  subcheck.lowerCase = work.pos.lowerCase
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-10" id="section-10"></a>
</div>
<p>no error in string describe possible, so go on</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  <span class="hljs-keyword">if</span> work.pos.lowerCase
    text += <span class="hljs-string">"It will be lowercased. "</span>
  <span class="hljs-keyword">if</span> work.pos.normalize
    text += <span class="hljs-string">"Extended formats like additional domains, subdomains and tags which
    mostly belong to the same mailbox will be removed. "</span>
  cb <span class="hljs-literal">null</span>, text

exports.run = <span class="hljs-function"><span class="hljs-params">(work, cb)</span> -&gt;</span>
  debug <span class="hljs-string">"<span class="hljs-subst">#{work.debug}</span> with <span class="hljs-subst">#{util.inspect work.value}</span> as <span class="hljs-subst">#{work.pos.type}</span>"</span>
  debug <span class="hljs-string">"<span class="hljs-subst">#{work.debug}</span> <span class="hljs-subst">#{chalk.grey util.inspect work.pos}</span>"</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-11" id="section-11"></a>
</div>
<p>base checks</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  <span class="hljs-keyword">try</span>
    <span class="hljs-keyword">if</span> check.optional.run work
      debug <span class="hljs-string">"<span class="hljs-subst">#{work.debug}</span> result <span class="hljs-subst">#{util.inspect work.value ? <span class="hljs-literal">null</span>}</span>"</span>
      <span class="hljs-keyword">return</span> cb()
  <span class="hljs-keyword">catch</span> error
    <span class="hljs-keyword">return</span> work.report error, cb
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-12" id="section-12"></a>
</div>
<p>validate using subcheck</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  name = work.spec.name ? <span class="hljs-string">'value'</span>
  <span class="hljs-keyword">if</span> work.path.length
    name += <span class="hljs-string">"/<span class="hljs-subst">#{work.path.join <span class="hljs-string">'/'</span>}</span>"</span>
  subcheck.lowerCase = work.pos.lowerCase
  check.run
    <span class="hljs-attribute">name</span>: name
    <span class="hljs-attribute">value</span>: work.value
    <span class="hljs-attribute">schema</span>: subcheck
  , <span class="hljs-function"><span class="hljs-params">(err, value)</span> -&gt;</span>
    <span class="hljs-keyword">return</span> cb err <span class="hljs-keyword">if</span> err
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-13" id="section-13"></a>
</div>
<p>validate</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    [local, host] = parts = value.split <span class="hljs-regexp">/@/</span>
    <span class="hljs-keyword">if</span> parts.length <span class="hljs-keyword">isnt</span> <span class="hljs-number">2</span>
      <span class="hljs-keyword">return</span> work.report (<span class="hljs-keyword">new</span> Error <span class="hljs-string">"The address is not a valid format, too few or
      much @-signs."</span>), cb
    <span class="hljs-keyword">if</span> local.length &gt; <span class="hljs-number">64</span>
      <span class="hljs-keyword">return</span> work.report (<span class="hljs-keyword">new</span> Error <span class="hljs-string">"The local mailbox name is too long (64 chars max)."</span>), cb
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-14" id="section-14"></a>
</div>
<p>check hostname</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    check.run
      <span class="hljs-attribute">name</span>: name + <span class="hljs-string">':host'</span>
      <span class="hljs-attribute">value</span>: host
      <span class="hljs-attribute">schema</span>:
        <span class="hljs-attribute">type</span>: <span class="hljs-string">'hostname'</span>
    , <span class="hljs-function"><span class="hljs-params">(err, host)</span> -&gt;</span>
      <span class="hljs-keyword">return</span> cb err <span class="hljs-keyword">if</span> err
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-15" id="section-15"></a>
</div>
<p>normalize</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">      [local, host] = normalize(host) local, host
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-16" id="section-16"></a>
</div>
<p>done everything ok</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">      value = <span class="hljs-string">"<span class="hljs-subst">#{local}</span>@<span class="hljs-subst">#{host}</span>"</span>
      <span class="hljs-keyword">return</span> cb <span class="hljs-literal">null</span>, value <span class="hljs-keyword">unless</span> work.pos.checkServer
      <span class="hljs-keyword">return</span> cb <span class="hljs-literal">null</span>, value <span class="hljs-keyword">if</span> host <span class="hljs-keyword">is</span> <span class="hljs-string">'localhost'</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-17" id="section-17"></a>
</div>
<p>check server</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">      getMyIP (err, ip) -&gt;
        <span class="hljs-keyword">if</span> err
          debug chalk.magenta <span class="hljs-string">"could not detect own ip address"</span>
          <span class="hljs-keyword">return</span> cb <span class="hljs-literal">null</span>, value
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-18" id="section-18"></a>
</div>
<p>find mx records</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">        dns = <span class="hljs-built_in">require</span> <span class="hljs-string">'dns'</span>
        dns.resolveMx host, <span class="hljs-function"><span class="hljs-params">(err, addresses)</span> -&gt;</span>
          checkMailServer addresses, ip, <span class="hljs-function"><span class="hljs-params">(ok)</span> -&gt;</span>
            <span class="hljs-keyword">return</span> cb <span class="hljs-literal">null</span>, value <span class="hljs-keyword">if</span> ok
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-19" id="section-19"></a>
</div>
<p>find a-record</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">            dns.resolve host, <span class="hljs-function"><span class="hljs-params">(err, addresses)</span> -&gt;</span>
              checkMailServer addresses, ip, <span class="hljs-function"><span class="hljs-params">(ok)</span> -&gt;</span>
                <span class="hljs-keyword">return</span> cb <span class="hljs-literal">null</span>, value <span class="hljs-keyword">if</span> ok
                <span class="hljs-keyword">return</span> work.report (<span class="hljs-keyword">new</span> Error <span class="hljs-string">"No correct responding mail server
                could be detected for this domain."</span>), cb

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="schema-check">
  <h2>
    <a href="#schema-check" name="schema-check" class="pilcrow"></a>
Schema check
  </h2>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">exports.selfcheck = <span class="hljs-function"><span class="hljs-params">(schema, cb)</span> -&gt;</span>
  check.run
    <span class="hljs-attribute">schema</span>:
      <span class="hljs-attribute">type</span>: <span class="hljs-string">'object'</span>
      <span class="hljs-attribute">allowedKeys</span>: <span class="hljs-literal">true</span>
      <span class="hljs-attribute">keys</span>: object.extend {}, check.base,
        <span class="hljs-attribute">default</span>: subcheck
        <span class="hljs-attribute">lowerCase</span>:
          <span class="hljs-attribute">type</span>: <span class="hljs-string">'boolean'</span>
          <span class="hljs-attribute">optional</span>: <span class="hljs-literal">true</span>
        <span class="hljs-attribute">normalize</span>:
          <span class="hljs-attribute">type</span>: <span class="hljs-string">'boolean'</span>
          <span class="hljs-attribute">optional</span>: <span class="hljs-literal">true</span>
        <span class="hljs-attribute">checkServer</span>:
          <span class="hljs-attribute">type</span>: <span class="hljs-string">'boolean'</span>
          <span class="hljs-attribute">optional</span>: <span class="hljs-literal">true</span>
    <span class="hljs-attribute">value</span>: schema
  , cb


</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="helper">
  <h2>
    <a href="#helper" name="helper" class="pilcrow"></a>
Helper
  </h2>
</div>
<div class="pilwrap" id="get-own-ip">
  <h3>
    <a href="#get-own-ip" name="get-own-ip" class="pilcrow"></a>
get own IP
  </h3>
</div>
<p>for later mail server checks</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">myIP = <span class="hljs-literal">null</span>
<span class="hljs-function"><span class="hljs-title">getMyIP</span> = <span class="hljs-params">(cb)</span> -&gt;</span>
  <span class="hljs-keyword">return</span> cb myIP <span class="hljs-keyword">if</span> myIP
  request = <span class="hljs-built_in">require</span> <span class="hljs-string">'request'</span>
  request <span class="hljs-string">'http://ipinfo.io/ip'</span>, <span class="hljs-function"><span class="hljs-params">(err, response, body)</span> -&gt;</span>
    <span class="hljs-keyword">return</span> cb err <span class="hljs-keyword">if</span> err
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> err <span class="hljs-keyword">and</span> response.statusCode <span class="hljs-keyword">is</span> <span class="hljs-number">200</span>
      cb <span class="hljs-literal">null</span>, body.trim()
    <span class="hljs-keyword">else</span>
      cb <span class="hljs-keyword">new</span> Error <span class="hljs-string">'could not get IP address'</span>

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="contact-the-server">
  <h3>
    <a href="#contact-the-server" name="contact-the-server" class="pilcrow"></a>
contact the server
  </h3>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript"><span class="hljs-function"><span class="hljs-title">checkMailServer</span> = <span class="hljs-params">(list, ip, cb)</span> -&gt;</span>
  <span class="hljs-keyword">return</span> cb <span class="hljs-literal">false</span> <span class="hljs-keyword">unless</span> list?.length
  net = <span class="hljs-built_in">require</span> <span class="hljs-string">'net'</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-23" id="section-23"></a>
</div>
<p>check email exchange server</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  list = list.sort (a, b) -&gt; a.priority - b.priority
  .map (e) -&gt; e.exchange
  async.detect list, <span class="hljs-function"><span class="hljs-params">(domain, cb)</span> -&gt;</span>
    debug chalk.grey <span class="hljs-string">"check mail server under <span class="hljs-subst">#{domain}</span>"</span>
    res = <span class="hljs-string">''</span>
    client = net.connect
      <span class="hljs-attribute">port</span>: <span class="hljs-number">25</span>
      <span class="hljs-attribute">host</span>: domain
    , <span class="hljs-function">-&gt;</span>
      client.write <span class="hljs-string">"HELO <span class="hljs-subst">#{ip}</span>\r\n"</span>
      client.end()
    client.<span class="hljs-literal">on</span> <span class="hljs-string">'data'</span>, <span class="hljs-function"><span class="hljs-params">(data)</span> -&gt;</span>
      res += data.toString()
    client.<span class="hljs-literal">on</span> <span class="hljs-string">'error'</span>, <span class="hljs-function"><span class="hljs-params">(err)</span> -&gt;</span>
      debug chalk.magenta err
    client.<span class="hljs-literal">on</span> <span class="hljs-string">'end'</span>, <span class="hljs-function">-&gt;</span>
      debug chalk.grey l <span class="hljs-keyword">for</span> l <span class="hljs-keyword">in</span> res.split <span class="hljs-regexp">/\n/</span>
      cb res?.length &gt; <span class="hljs-number">0</span>
  , cb

</pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>
